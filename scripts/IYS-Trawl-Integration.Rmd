---
title: "IYS-Trawl-Integration"
author: "Tim van der Stap"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(lubridate)
library(chron)
library(janitor)
library(oce) # for computing depth from pressure and latitude
library(dm)
library(DiagrammeR)
knitr::opts_chunk$set(echo = TRUE)
```

For date integration, first download the processed data. For the 2022 data, this will be included in the IYS-data-template. From public repositories, we can download straight from the repository:  

```{r download IYS data template files}
download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("input_datasets", "2022", "IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-TINRO-Data-Template/blob/main/IYS2022_TINRO.xlsx?raw=true", here::here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/IYS2022_Shimada_Data_template.xlsx?raw=true", here::here("input_datasets", "2022", "IYS2022_Shimada_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-Franklin-Data-Template/blob/main/IYS_2022_FRANKLIN.xlsx?raw=true", here::here("input_datasets", "2022", "IYS2022_Franklin_Data.xlsx"), quiet = TRUE, mode = "wb")

# Separate file for the Shimada marks/scars data:
download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/original_data/Shimada%20adhesion%20scar%20data.xlsx?raw=true", here::here("input_datasets", "2022", "IYS2022_Shimada_MarksScars_Data.xlsx"), quiet = TRUE, mode = "wb")

# Remove comment from following lines of code once 2019 and 2020 trawl data is in a public repository:

# download.file(" ", here::here("input_datasets", "GoA2019_Fish_Trawl_catchdata.xlsx"), quiet = TRUE, mode = "wb")
# download.file(" ", here::here("input_datasets", "GoA2019_Fish_Specimen.xlsx"), quiet = TRUE, mode = "wb")
# download.file(" ", here::here("input_datasets", "GoA2020_Fish_Trawl_catch.xlsx"), quiet = TRUE, mode = "wb")
# download.file(" ", here::here("input_datasets", "GoA2020_Fish_Specimen.xlsx"), quiet = TRUE, mode = "wb")
# download.file(" ", here::here("input_datasets", "IYS2022_Zooplankton_Template.xlsx"), quiet = TRUE, mode = "wb")

```

## Event Data 

Now that we have the latest versions of the data downloaded, we can read them in:

```{r event data}
# For the Trawl data:
NW_event <- read_excel(here("input_datasets", "2022", "IYS2022_NW_Data.xlsx"), sheet = "Sampling_Event_Info") %>%
  filter(Event_Type %in% c("CanTrawl", "CTD", "Bongo")) |> 
  mutate(Event_Type = gsub("Can", "", Event_Type))

TINRO_event <- read_excel(here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), 
                          sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type %in% c("Trawl", "CTD", "Bongo"))

Shimada_event <- read_excel(here("input_datasets", "2022", "IYS2022_Shimada_Data.xlsx"),
                            sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type %in% c("Trawl", "CTD", "Bongo"))

Franklin_event <- read_excel(here("input_datasets", "2022", "IYS2022_Franklin_Data.xlsx"),
                             sheet = "3. SAMPLING EVENT INFO") |> 
  filter(Event_Type %in% c("Trawl", "CTD_Rosette", "Bongo"))

#TODO Update 2019 event and catch data to read directly from public git repo
# Need to download this file manually from 2019 Trawl git repo
GoA2019_event <- read_excel(here("input_datasets", "2019",
                                 "2019_GoA_Fish_Trawl_catchdata.xlsx"),
                            sheet = "BRIDGE_LOG_FINAL") %>% filter(EVENT_TYPE %in% c("Trawl", "Can EEZ")) 

#TODO Update 2020 event and catch data to read directly from public git repo
# Need to download this file manually from 2020 Trawl git repo
GoA2020_event <- read_excel(here("input_datasets", "2020",
                                 "JuvSalmon_2020-01_Catch_v2021.1C_FINAL SUBMIT_jan18_2021 (2).xlsx"), 
                            sheet = "BRIDGE_LOG_FINAL")

#TODO: Update 2019 and 2020 Bongo data to read directly from public git repo
# Need to download this file manually. Select only data for net 1, which was used for taxonomic analysis.
Bongo2019_event <- read.csv(here("input_datasets", "2019", "bongo2019_event.csv"), stringsAsFactors = F)
Bongo2019_event <- Bongo2019_event[63:178,] 
Bongo2019_event <- Bongo2019_event %>% 
  filter(grepl("Net1", eventID))

# Add bottom depth:
Bongo2019_bottomdepth <- read_excel(here("input_datasets", "2019", "IYS cruise logbook_2019.xlsx"), 
                                    sheet = "Bongo metadata") %>%
  select(station = Station, 
         bottom_depth_meters = Depth) %>% 
  mutate(station = as.character(station)) %>%
  distinct()

Bongo2020_event <- read.csv(here("input_datasets", "2020", "bongo2020_event.csv"), stringsAsFactors = F)
Bongo2020_event <- Bongo2020_event[43:122,]
Bongo2020_event <- Bongo2020_event %>% filter(grepl("Net1", eventID))

# Raw Spirit event data 
#TODO: Replace the planned stations file below with actual stations conducted once data are received.
#raw_spirit_event <- read_csv(here("input_datasets", "planned_raw_spirit_stations.csv")) |> 
#  rename(latitude_start_decdeg = lat, longitude_start_decdeg = lon) |> 
#  mutate(vessel_name_abbr = "Raw_Spirit",
#         event_type = "Gillnet",
#         year = 2022,
#         comments = "This Raw Spirit event data only includes planned station coordinates") |> 
#  select(vessel_name_abbr, event_type, year, latitude_start_decdeg, longitude_start_decdeg)
```

Compare event tables from the various vessel sampling events:

```{r event comparison}
# Check for differences in column header names and class between those data frames:
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event, Franklin_event)
```

Looks like we have to do a little bit of cleaning before we join the data frames!

```{r event cleaning}
# For NOAA Bell M. Shimada data:
Shimada_event <- Shimada_event %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S"),
         Time_Zone_Code = "UTC") %>%
  dplyr::rename(Bottom_Depth_Meters = `Bottom_Depth*_Meters`) |> 
  rename_with(tolower)

Shimada_event$station <- as.character(Shimada_event$station)

# For NW Explorer data:
NW_event <- NW_event %>%
  dplyr::rename(Maximum_Sampling_Depth_Meters = Maximum_Sampling_Depth,
                Minimum_Sampling_Depth_Meters = Minimum_Sampling_Depth,
                Cruise_name = Cruise_Name) %>% 
  mutate(Time_Zone_Code = "UTC") %>%
  select(-...5)

NW_event$Month <- as.numeric(NW_event$Month)
NW_event$Day <- as.numeric(NW_event$Day)
NW_event$Time_End <- as.POSIXct(NW_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")
NW_event$Time_Start <- as.POSIXct(NW_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

NW_event <- NW_event |> 
  rename_with(tolower)

# Remove Can from the station_event_id:
NW_event$station_event_id <- gsub("Can", "", NW_event$station_event_id)

# Remove one duplicate Bongo event id, as this was a bad tow, and there's no associated information:
NW_event <- NW_event %>% filter(!grepl('Bad tow', comments))

NW_event$station <- as.character(NW_event$station)

# For TINRO Data:
# Trawl data is collected in GMT+12:00. So we have to subtract 12 hours from the Time_Start and Time_End to get to UTC. Additionally, we have to make sure this is then accurately reflected in the sampling **day** as well!
hrs <- 12 * 60 * 60

TINRO_event$date <- as.Date(paste(TINRO_event$Year, TINRO_event$Month, TINRO_event$Day, sep = "-"))
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S")
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H%:%M:%S") 
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")

TINRO_event <- TINRO_event %>%
  mutate(eventDate_start = paste(date, Time_Start))
TINRO_event <- TINRO_event %>%
  mutate(eventDate_start = as.POSIXlt(TINRO_event$eventDate_start))

# Only the trawl data was recorded in Z+1200 - change to UTC:
TINRO_trawl <- TINRO_event %>% filter(Event_Type == "Trawl")

TINRO_trawl$Time_End <- as.POSIXct(TINRO_trawl$Time_End, format = "%H:%M:%S")
TINRO_trawl$Time_End <- TINRO_trawl$Time_End - hrs
TINRO_trawl$Time_End <- as.POSIXct(TINRO_trawl$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S") 

TINRO_trawl$Time_Start <- as.POSIXct(TINRO_trawl$Time_Start, format = "%H:%M:%S")
TINRO_trawl$Time_Start <- TINRO_trawl$Time_Start - hrs
TINRO_trawl$Time_Start <- as.POSIXct(TINRO_trawl$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

TINRO_trawl$eventDate_start$hour = TINRO_event$eventDate_start$hour-12

# Subset of all sampling events except trawl:
TINRO <- TINRO_event[TINRO_event$Event_Type != "Trawl",]

# Connect these subsets back:
TINRO_event <- rbind(TINRO_trawl, TINRO)

TINRO_event$eventDate_start <- as.character(TINRO_event$eventDate_start)

TINRO_event$Year <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%Y"))
TINRO_event$Month <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%m"))
TINRO_event$Day <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%d"))

# Reformat time, and transform to UTC:
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

# Sampling duration minutes has to be reformatted.
TINRO_event$Sampling_Duration_Minutes <- 60 * 24 *  as.numeric(chron::times(TINRO_event$Sampling_Duration_Minutes)) 
TINRO_event$Sampling_Duration_Minutes <- round(TINRO_event$Sampling_Duration_Minutes, digits = 0)

# Change Time_Zone_Code to state that the Time_Start and Time_End now reflects UTC:
TINRO_event$Time_Zone_Code <- "UTC"

# Change station class to character:
TINRO_event$Station <- as.character(TINRO_event$Station)

# Remove temporary columns:
TINRO_event <- TINRO_event %>% select(-c(date, eventDate_start)) |> 
  rename_with(tolower)

# For Franklin data:
Franklin_event$Month <- ifelse(Franklin_event$Month == "Feb", "2", "3") %>% as.numeric()

# Change Tow_distance from kilometers per hour to nautical miles:
Franklin_event$Tow_distance <- as.numeric(Franklin_event$Tow_distance)
Franklin_event <- Franklin_event %>%
  mutate(tow_distance_nautical_miles = Tow_distance / 1.852)

Franklin_event$tow_distance_nautical_miles <- round(Franklin_event$tow_distance_nautical_miles, digits = 4)

Franklin_event <- Franklin_event %>% mutate(Time_Start_UTC = gsub(".*T", "", Franklin_event$Time_Start_UTC)) 
Franklin_event <- Franklin_event %>% mutate(Time_End_UTC = gsub(".*T", "", Franklin_event$Time_End_UTC))
Franklin_event <- Franklin_event %>% mutate(Time_Start_UTC = gsub("Z","",Franklin_event$Time_Start_UTC)) 
Franklin_event <- Franklin_event %>% mutate(Time_End_UTC = gsub("Z", "", Franklin_event$Time_End_UTC))

Franklin_event$Time_End_UTC <- as.POSIXct(Franklin_event$Time_End_UTC, format = "%H:%M:%S")  %>% format("%H:%M:%S")
Franklin_event$Time_Start_UTC <- as.POSIXct(Franklin_event$Time_Start_UTC, format = "%H:%M:%S") %>% format("%H:%M:%S")

# Rename and select columns to integrate:
Franklin_event <- Franklin_event %>%  
  rename_with(tolower) %>%
  dplyr::rename(alternative_event_id = dfo_station_event_id,
                time_start = time_start_utc,
                time_end = time_end_utc,
                tow_speed_kilometers_per_hour = tow_speed,
                bottom_depth_meters = bottom_depth_start,
                wave_height_meters = wave_height,
                sampling_duration_minutes = sampling_duration)

Franklin_event <- Franklin_event %>%
  mutate(time_zone_code = "UTC",
         wind_direction_degrees = NA,
         wind_direction_kilometers_per_hour = NA,
         swell_height_meters = NA,
         weather_description = NA) %>%
  select(-c(trip_id, event_number, tow_speed_units, tow_distance, tow_distance_units,
            bottom_depth_units, wave_height_units, sampling_duration_units))

Franklin_event$sampling_duration_minutes <- as.numeric(Franklin_event$sampling_duration_minutes)
Franklin_event$minimum_sampling_depth_meters <- as.numeric(Franklin_event$minimum_sampling_depth_meters)
Franklin_event$maximum_sampling_depth_meters <- as.numeric(Franklin_event$maximum_sampling_depth_meters)
Franklin_event$wave_height_meters <- as.numeric(Franklin_event$wave_height_meters)
```

Clean up the Bongo2019, Bongo2020, and Bongo2022 Zooplankton event data:

```{r Bongo event cleaning}
Bongo2019_event <- Bongo2019_event %>%
  mutate(day = as.numeric(Bongo2019_event$day),
         month = as.numeric(Bongo2019_event$month),
         year = as.numeric(Bongo2019_event$year),
         zone = NA,
         cruise_name = "GoA2019",
         event_type = "Bongo",
         vessel_name_abbr = "Kaganovsky",
         station = gsub("IYS:GoA2019:Stn", "", Bongo2019_event$parentEventID),
         event_date = as.POSIXct(paste(year,month,day, sep = "-")),
         time_start = gsub(".*T", "", eventDate),
         time_start = gsub("Z", "", time_start),
         time_zone_code = "UTC",
         minimum_sampling_depth_meters = 0,
         station_event_id = paste(cruise_name, vessel_name_abbr, station, event_type, sep = "-")) %>%
  rename(maximum_sampling_depth_meters = maximumDepthInMeters,
         latitude_start_decdeg = decimalLatitude,
         longitude_start_decdeg = decimalLongitude) %>%
  select(-eventID) %>%
  distinct()

Bongo2019_event <- left_join(Bongo2019_event, Bongo2019_bottomdepth, by = "station")

Bongo2020_event <- Bongo2020_event %>%
  mutate(day = as.numeric(Bongo2020_event$day),
         month = as.numeric(Bongo2020_event$month),
         year = as.numeric(Bongo2020_event$year),
         zone = NA,
         cruise_name = "GoA2020",
         event_type = "Bongo",
         vessel_name_abbr = "Legacy",
         station = gsub("IYS:GoA2020:Stn", "", Bongo2020_event$parentEventID),
         event_date = as.POSIXct(paste(year,month,day, sep = "-")),
         time_start = gsub(".*T", "", eventDate),
         time_start = gsub("Z", "", time_start),
         time_zone_code = "UTC",
         minimum_sampling_depth_meters = 0,
         station_event_id = paste(cruise_name, vessel_name_abbr, station, event_type, sep = "-")) %>%
  rename(maximum_sampling_depth_meters = maximumDepthInMetres,
         latitude_start_decdeg = decimalLatitude,
         longitude_start_decdeg = decimalLongitude) %>%
  select(-eventID) %>%
  distinct()

bongo_event <- dplyr::bind_rows(Bongo2019_event, Bongo2020_event) %>%
  select(cruise_name, vessel_name_abbr, zone, station, event_type, station_event_id, event_date, year,
         month, day, time_start, time_zone_code, minimum_sampling_depth_meters,
         maximum_sampling_depth_meters, latitude_start_decdeg, longitude_start_decdeg)
```

Clean up the GoA2019 Trawl event data:

```{r GOA2019 event cleaning}
# Make sure the Event_type is consistently "trawl":
GoA2019_event$EVENT_TYPE <- "Trawl"

# Change deployment and retrieval time from hhmm to hh:mm
GoA2019_event$END_DEPLOYMENT_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$END_DEPLOYMENT_TIME), format = "%H%M"), 12, 16) 
GoA2019_event$BEGIN_RETRIEVAL_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$BEGIN_RETRIEVAL_TIME), format = "%H%M"), 12, 16)

# Change the date/time to UTC: 
GoA2019_event <- GoA2019_event %>%
  mutate(eventDate_start = as.POSIXct(paste(EVENT_DATE_START, END_DEPLOYMENT_TIME)),
         eventDate_finish = as.POSIXct(paste(EVENT_DATE_FINISH, BEGIN_RETRIEVAL_TIME)))

GoA2019_event$eventDate_start <- lubridate::ymd_hms(GoA2019_event$eventDate_start, tz = "Asia/Vladivostok")
GoA2019_event$eventDate_start <- lubridate::with_tz(GoA2019_event$eventDate_start, "UTC")
GoA2019_event$eventDate_finish <- lubridate::ymd_hms(GoA2019_event$eventDate_finish, tz = "Asia/Vladivostok")
GoA2019_event$eventDate_finish <- lubridate::with_tz(GoA2019_event$eventDate_finish, "UTC")

# Extract time from the created eventDate_start and eventDate_finish:
GoA2019_event <- GoA2019_event %>% mutate(Time_Start = format(eventDate_start, "%H:%M:%S"),
                                          Time_End = format(eventDate_finish, "%H:%M:%S"))

GoA2019_event <- GoA2019_event %>%
  mutate(Cruise_name = "IYS2019",
         Vessel_Name_Abbr = "Kaganovsky",
         Zone = NA,
         Time_Zone_Code = "UTC",
         Minimum_Sampling_Depth_Meters = 0) %>%
  dplyr::rename(Station = TOW_NUMBER,
                Event_Type = EVENT_TYPE,
                Sampling_Duration_Minutes = TOW_DURATION,
                Day_Night = `Day /Night`,
                Maximum_Sampling_Depth_Meters = MOUTH_OPENING_HEIGHT,
                Latitude_Start_DecDeg = START_LATITUDE_DD,
                Longitude_Start_DecDeg = longitude,
                Latitude_End_DecDeg = END_LATITUDE_DD,
                Longitude_End_DecDeg = END_LONGITUDE_DD,
                Tow_distance_nautical_miles = DISTANCE_TRAVELLED,
                Tow_speed_kilometers_per_hour = SPEED,
                Wind_Direction_Degrees = WIND_DIRECTION,
                Wind_Speed_kilometers_per_hour = WIND_SPEED,
                Weather_description = WEATHER_COMMENTS, 
                Comments = `COMMENTS TRANSLATED TO ENGLISH`)

GoA2019_event$Year <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%Y"))
GoA2019_event$Month <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%m"))
GoA2019_event$Day <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%d"))

# Change some classes:
GoA2019_event$Wind_Direction_Degrees <- as.numeric(GoA2019_event$Wind_Direction_Degrees)
GoA2019_event$Wind_Speed_kilometers_per_hour <- as.numeric(GoA2019_event$Wind_Speed_kilometers_per_hour)
GoA2019_event$Station <- as.character(GoA2019_event$Station)

GoA2019_event <- GoA2019_event %>%
  mutate(Sampling_Duration_Minutes = Sampling_Duration_Minutes * 60,
         station_event_id = paste(Cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Longitude_End_DecDeg = Longitude_End_DecDeg * -1,
         Bottom_Depth_Meters = rowMeans(GoA2019_event[ , c("BOTTOM_DEPTH_START_METERS", "BOTTOM_DEPTH_END_METERS")], na.rm = TRUE)) %>%
  select(Cruise_name, Vessel_Name_Abbr, Zone, Station, station_event_id, 
         Event_Type, Year, Month, Day, Time_Start, Time_End, Sampling_Duration_Minutes,
         Day_Night, Time_Zone_Code, Minimum_Sampling_Depth_Meters, 
         Maximum_Sampling_Depth_Meters, Tow_speed_kilometers_per_hour, Latitude_Start_DecDeg, 
         Longitude_Start_DecDeg, Latitude_End_DecDeg, Longitude_End_DecDeg, 
         Bottom_Depth_Meters, Tow_distance_nautical_miles,
         Wind_Direction_Degrees, Wind_Speed_kilometers_per_hour, Comments) |> 
  rename_with(tolower)

# Include CTD events
# Create event data for 2019 CTD
IYS_2019_CTD <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2019-CTD/main/standardized_data/IYS_2019_CTD.csv", guess_max = 60000)

ctd_2019_event <- IYS_2019_CTD |> 
   select(cruise_name:bottom_depth_meters) |> 
  distinct() |> 
  mutate(time_start = as.character(time_start)) |> 
  rename(station_event_id = station_event_ID)

ctd_2019_event$station <- as.character(ctd_2019_event$station)

janitor::compare_df_cols(GoA2019_event, ctd_2019_event)

GoA2019_event <- bind_rows(GoA2019_event, ctd_2019_event)
#TODO: confirm station number for trawls and ctd casts match
```

```{r GOA2020 event cleaning}
GoA2020_event <- GoA2020_event %>%
  mutate(Cruise_name = "IYS2020",
         Vessel_Name_Abbr = "Legacy",
         Zone = NA,
         Time_Zone_Code = "UTC",
         Minimum_Sampling_Depth_Meters = 0,
         Event_Type = "Trawl")

# Change the date/time to UTC: 
GoA2020_event$TIME_FISHING_START <- format(GoA2020_event$TIME_FISHING_START, "%H:%M:%S")
GoA2020_event$TIME_NET_RETREIVAL_START <- format(GoA2020_event$TIME_NET_RETREIVAL_START, "%H:%M:%S")

GoA2020_event <- GoA2020_event %>%
  mutate(eventDate_start = as.POSIXct(paste(EVENT_DATE, TIME_FISHING_START)),
         eventDate_finish = as.POSIXct(paste(EVENT_DATE, TIME_NET_RETREIVAL_START)))

GoA2020_event$eventDate_start <- lubridate::ymd_hms(GoA2020_event$eventDate_start, tz = "America/Los_Angeles") 
GoA2020_event$eventDate_start <- lubridate::with_tz(GoA2020_event$eventDate_start, "UTC")
GoA2020_event$eventDate_finish <- lubridate::ymd_hms(GoA2020_event$eventDate_finish, tz = "America/Los_Angeles")
GoA2020_event$eventDate_finish <- lubridate::with_tz(GoA2020_event$eventDate_finish, "UTC")

GoA2020_event <- GoA2020_event %>%
  dplyr::rename(Station = SET_NUMBER,
                Sampling_Duration_Minutes = `DURATION OF TOW (min)`,
                Day_Night = `DAY/NIGHT`,
                Latitude_Start_DecDeg = START_LAT_DECDEGREE,
                Longitude_Start_DecDeg = START_LONG_DECDEGREE,
                Latitude_End_DecDeg = END_LAT_DECDEGREE,
                Longitude_End_DecDeg = END_LONG_DECDEGREE,
                Tow_distance_nautical_miles = `DISTANCE OF FISHING OPERATION (nm)`,
                Wind_Direction_Degrees = `WIND DIRECTION (degrees)`,
                Wind_Speed_kilometers_per_hour = `WIND SPEED (knots)`, 
                Weather_description = `CLOUD/WEATHER`, 
                Comments = COMMENTS)

GoA2020_event$Year <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%Y"))
GoA2020_event$Month <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%m"))
GoA2020_event$Day <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%d"))

# Change some classes:
GoA2020_event$Wind_Direction_Degrees <- as.numeric(GoA2020_event$Wind_Direction_Degrees)
GoA2020_event$Wind_Speed_kilometers_per_hour <- as.numeric(GoA2020_event$Wind_Speed_kilometers_per_hour)
GoA2020_event$Station <- as.character(GoA2020_event$Station)

# For Maximum_Sampling_Depth_Meters, Bottom_Depth_Meters and Tow_speed_kilometers_per_hour, these were measured at 15 minutes intervals. We'll take the average:
GoA2020_event <- GoA2020_event %>%
  mutate(Maximum_Sampling_Depth_Meters = 
  rowMeans(GoA2020_event[ , c("NET OPENING DEPTH (metres) - 15 min", "NET OPENING DEPTH (metres) - 30 min", "NET OPENING DEPTH (metres) - 45 min", "NET OPENING DEPTH (metres) - END")], na.rm = TRUE),
  Bottom_Depth_Meters = rowMeans(GoA2020_event[ , c("BOTTOM DEPTH (M) - 15 min", "BOTTOM DEPTH (M) - 30 min", "BOTTOM DEPTH (M) - 45 min", "BOTTOM DEPTH (M) - END")], na.rm = TRUE),
  Tow_speed_kilometers_per_hour = rowMeans(GoA2020_event[ , c("SPEED (Kn) - 15 min", "SPEED (Kn) - 30 min", "SPEED (Kn) - 45 min", "SPEED (Kn) - END")], na.rm = TRUE))

GoA2020_event <- GoA2020_event %>%
  mutate(station_event_id = paste(Cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-")) %>%
  select(Cruise_name, Vessel_Name_Abbr, Zone, Station, station_event_id, 
         Event_Type, Year, Month, Day,
         Time_Start = eventDate_start,
         Time_End = eventDate_finish, 
         Sampling_Duration_Minutes,
         Day_Night, Time_Zone_Code, Minimum_Sampling_Depth_Meters, Maximum_Sampling_Depth_Meters,
         Bottom_Depth_Meters, Tow_speed_kilometers_per_hour,
         Latitude_Start_DecDeg, Longitude_Start_DecDeg, Latitude_End_DecDeg, Longitude_End_DecDeg, 
         Tow_distance_nautical_miles, Wind_Direction_Degrees, Wind_Speed_kilometers_per_hour, Comments) 

GoA2020_event <- GoA2020_event %>% mutate(Time_Start = format(Time_Start, "%H:%M:%S"),
                                          Time_End = format(Time_End, "%H:%M:%S"))

# Change tow speed, currently in knots, to kilometers per hour for easy integration:
GoA2020_event$Tow_speed_kilometers_per_hour <-  GoA2020_event$Tow_speed_kilometers_per_hour * 1.852

GoA2020_event <- GoA2020_event %>% rename_with(tolower)

#TODO: Check with Chrys Neville whether the event_date for set_number 13 should be March 19 instead of March 18.
#TODO: Require trawl coordinates for set_number 20. 

# Import event data for 2020 CTD
ctd_2020_events <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2020-CTD/master/standardized_data/ctd_events.csv") |> 
  rename(station_event_id = station_event_ID) |> 
  mutate(time_start = as.character(time_start),
         time_end = as.character(time_end),
         station = as.character(station))

janitor::compare_df_cols(GoA2020_event, ctd_2020_events)

GoA2020_event <- bind_rows(GoA2020_event, ctd_2020_events)

```

Finally, join the data frames into a single sampling event data table: 

```{r All sampling events}
# Check for differences in column header names and class between those two data frames. 
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event, Franklin_event, 
                         bongo_event, GoA2019_event, GoA2020_event)

# Join the individual event data frames from all IYS High Seas Expeditions and make all column names :
IYS_events <- bind_rows(TINRO_event, NW_event, Shimada_event, Franklin_event, bongo_event, 
                        GoA2019_event, GoA2020_event) |> 
  mutate(event_date = paste0(year,"-", 
                             ifelse(nchar(month) < 2, 
                                    paste0("0", month), month), "-",
                             ifelse(nchar(day) < 2,
                                    paste0("0", day),day), 
                             "T", time_start, "Z")) |> 
  select(cruise_name:station_event_id, alternative_event_id, event_date, year:comments) |> 
  mutate(day_night = tolower(day_night),
         date = as.Date(event_date, format = "%Y-%m-%d"),
         day_of_year = lubridate::yday(date)) %>%
  select(-date)

# There were three trawl events IYS trawl catch 
IYS_events <- IYS_events %>%
  mutate(comments = ifelse(station_event_id == "IYS2022-TINRO-3-6-Trawl", 
                           "Trawl was successful, but no species were caught.", comments),
         comments = ifelse(station_event_id == "IYS2022-Shimada-4-2-Trawl", 
                           "Codend wasn't fully closed so nothing was retained in codend.", comments),
         comments = ifelse(station_event_id == "IYS2019-Kaganovsky-61-Trawl",
                           "Trawling is not for enumeration. Testing live box", comments))

# Add dataset DOI by vessel:
IYS_events <- IYS_events %>%
  mutate(dataset_doi = case_when(
    vessel_name_abbr == "TINRO" & event_type == "Trawl" ~ "https://doi.org/10.21966/wevm-ww19",
    vessel_name_abbr == "TINRO" & event_type == "CTD" ~ "https://doi.org/10.21966/rfv4-e505",
    vessel_name_abbr == "TINRO" & event_type == "Bongo" ~ "https://doi.org/10.21966/ymv6-8024",
    vessel_name_abbr == "Shimada" & event_type == "Trawl" ~ "https://doi.org/10.21966/nt8w-je90",
    vessel_name_abbr == "Shimada" & event_type == "Bongo" ~ "https://doi.org/10.21966/ymv6-8024",
    vessel_name_abbr == "Shimada" & event_type == "CTD" ~ "https://doi.org/10.21966/YGT4-M087",
    vessel_name_abbr == "Franklin" & event_type == "Trawl" ~ "https://doi.org/10.21966/gmrz-ad56", 
    vessel_name_abbr == "Franklin" & event_type == "CTD_Rosette" ~ "https://doi.org/10.21966/4nv8-tm66",
    vessel_name_abbr == "NW" & event_type == "Trawl" ~ "https://doi.org/10.21966/shnm-s480",
    vessel_name_abbr == "NW" & event_type == "Bongo" ~ "https://doi.org/10.21966/ymv6-8024",
    vessel_name_abbr == "Kaganovsky" & event_type == "Trawl" ~ "https://doi.org/10.21966/DPHZ-AS73",
    vessel_name_abbr == "Kaganovsky" & event_type == "CTD" ~ "https://doi.org/10.21966/66gj-7q46",
    vessel_name_abbr == "Legacy" & event_type == "Trawl" ~ "https://doi.org/10.21966/4J6T-GB64",
    vessel_name_abbr == "Legacy" & event_type == "CTD" ~ "https://doi.org/10.21966/nkc2-9m58",
    vessel_name_abbr == "Legacy" & event_type == "Bongo" ~ "https://doi.org/10.21966/7cmt-ca72",
    vessel_name_abbr == "Kaganovsky" & event_type == "Bongo" ~ "https://doi.org/10.21966/7cmt-ca72",
    vessel_name_abbr == "Kaganovsky" & event_type == "Trawl" ~ "https://doi.org/10.21966/DPHZ-AS73",
    vessel_name_abbr == "Kaganovsky" & event_type == "CTD" ~ "https://doi.org/10.21966/66gj-7q46"))

# Replace NAs with blank cells and remove empty columns.
IYS_events <- IYS_events %>% mutate(across(is.character,~na_if(trimws(.),""))) %>%
   remove_empty("cols")

# Replace NaNs with blank cells:
IYS_events$maximum_sampling_depth_meters <- gsub("NaN", "", IYS_events$maximum_sampling_depth_meters)
IYS_events$maximum_sampling_depth_meters <- as.numeric(IYS_events$maximum_sampling_depth_meters)

# Rounding of values for several columns:
IYS_events <- IYS_events %>% mutate_at(vars(maximum_sampling_depth_meters, tow_speed_kilometers_per_hour,
                                            tow_distance_nautical_miles, wind_direction_degrees,
                                            wind_speed_kilometers_per_hour), funs(round(., 0)))

# Rename alternative_event_id to original_event_id:
IYS_events <- IYS_events %>%
  rename(original_event_id = alternative_event_id)

IYS_events <- sapply(IYS_events, as.character)
IYS_events[is.na(IYS_events)] <- ""
IYS_events <- as_tibble(IYS_events)

#QC event data
IYS_events |> group_by(vessel_name_abbr, event_type) |> 
  tally()

# Check for duplicate station_event_ids:
dups <- IYS_events %>% group_by(station_event_id) %>% filter(n() > 1)

summary(IYS_events)

# Save event data:
write_csv(IYS_events, here("output_datasets", "IYS_events.csv"))
```

## Catch Data

Now let's join the overall catch data from these vessels into a specific data frame as well. 

```{r IYS Catch clean}
# For TINRO catch:
TINRO_catch <- read_excel(here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), 
                          sheet = "5. CATCH_FINAL INFO")

TINRO_catch <- TINRO_catch %>% rename_with(tolower) %>%
  mutate(verbatim_identification = scientific_name)

# For NW Explorer catch:
NW_catch <- read_excel(here("input_datasets", "2022", "IYS2022_NW_Data.xlsx"), 
                       sheet = "Catch_Info")

NW_catch <- NW_catch %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Species_recorded = Species_Recorded,
                Catch_weight = Catch_Weight,
                Catch_count = Catch_Count) %>%
    rename_with(tolower) %>%
    mutate(verbatim_identification = scientific_name) 

# Remove Can from station_event_id and catch_id
NW_catch$station_event_id <- gsub("Can", "", NW_catch$station_event_id)
NW_catch$catch_id <- gsub("Can", "", NW_catch$catch_id)

# For NOAA Bell M. Shimada catch:
Shimada_catch <- read_excel(here("input_datasets", "2022", "IYS2022_Shimada_Data.xlsx"), 
                            sheet = "5. CATCH_FINAL INFO")

Shimada_catch <- Shimada_catch %>%
  dplyr::rename(dateIdentified = `dateIdentified (UTC)`) %>%
  rename_with(tolower) %>%
  mutate(verbatim_identification = scientific_name)

# For Franklin catch:
Franklin_catch <- read_excel(here("input_datasets", "2022", "IYS2022_Franklin_Data.xlsx"), 
                             sheet = "4. CATCH_FINAL INFO")

Franklin_catch <- Franklin_catch %>% rename_with(tolower) %>% select(-speciesid) %>%
  dplyr::rename(alternative_catch_id = dfo_catch_id,
                alternative_event_id = dfo_station_event_id) %>%
  mutate(verbatim_identification = scientific_name) %>%
  rename_with(tolower)

Franklin_catch$catch_count <- as.numeric(Franklin_catch$catch_count)
Franklin_catch$catch_weight <- as.numeric(Franklin_catch$catch_weight)

# For the Gulf of Alaska (GoA) 2019 catch data:
GoA2019_catch <- read_excel(here("input_datasets", "2019", "2019_GoA_Fish_Trawl_catchdata.xlsx"), 
                            sheet = "CATCH_FINAL")

GoA2019_catch <- GoA2019_catch %>%
  mutate(cruise_name = "IYS2019",
         Vessel_Name_Abbr = "Kaganovsky",
         Zone = NA,
         Event_Type = "Trawl")
```

**IMPORTANT**: Please note, that most of the catch_count comes from a column `CATCH_COUNT (pieces)(** includes Russian expansion for some species)`. In the original metadata this column is defined as _Total catch count. Note for most species this is *total catch in cod end*. However, for some small fish and jellies, this is the expanded count based on Russian expansion_. There is also a column _Number_codend (no expansion)_. If values are provided in **both** columns, the catch_count reflects the _Number_codend (no expansion)_ value! 

As the catch_count most often is the total catch **in the cod end**, the catch_weight reflects the mass in the codend (without expansion), which in the original metadata is defined as _Weight in cod-end - no expansion_.  

```{r IYS Catch cont., eval = FALSE}
GoA2019_catch <- GoA2019_catch %>%
  mutate(catch_count = ifelse(is.na(`Number_codend (no expansion)`), 
                              `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, 
                              ifelse(is.na(`CATCH_COUNT (pieces)(**includes Russian expansion for some species)`), 
                              `Number_codend (no expansion)`,
                              ifelse(`Number_codend (no expansion)` <= `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, `Number_codend (no expansion)`, NA))))

# Just check manually:
check_catches <- GoA2019_catch %>% select(`CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, `Number_codend (no expansion)`, catch_count)

GoA2019_catch <- GoA2019_catch %>%
  dplyr::rename(Station = `TOW_NUMBER (number)`,
                common_name = `common name`,
                Catch_weight = `Mass_codend (no expansion)`,
                species_code_russian = `SPECIES_CODE (russian))`,
                Lifestage = `age group ( for salmon 5= juv, 4 immature, 3 mature, 0 unknown)`,
                Comments = COMMENTS) %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Catch_ID = paste(Station_Event_ID, row_number(), sep = "-"),
         Species_recorded = NA,
         Scientific_Name = paste(genus, species, sep = " "), 
         verbatim_identification = paste(genus, species, sep = " "), 
         Taxonomic_rank = ifelse(grepl("sp.", GoA2019_catch$species), "genus", "species"),
         Catch_weight_units = "kilograms") %>%
  select(Station, Station_Event_ID, Catch_ID, Species_recorded, Scientific_Name, verbatim_identification,
         Taxonomic_rank, species_code_russian, Lifestage, common_name, Catch_weight, Catch_weight_units, 
         catch_count, Comments) %>%
  rename_with(tolower)

GoA2019_catch <- GoA2019_catch %>%
  mutate(lifestage = case_when(
    lifestage == "5" ~ "juvenile",
    lifestage == "4" ~ "immature",
    lifestage == "3" ~ "mature",
    lifestage == "0" ~ "unknown"))

# Remove the sp., sp and gen. sp. 1 from the worms_scientific_name column, as the taxonomic rank is provided in a different column:
GoA2019_catch$scientific_name <- gsub("\\b sp.\\b|\\b sp\\b|\\b gen. sp. 1\\b", "", GoA2019_catch$scientific_name) 

# Finally, in the specimen data there is mention of Periphylla periphylla caught, however after matching to the species_code_russian, this is included in the catch data as Chrysaora melonaster. Therefore, we change this in the GoA2019_catch data. 
#TODO: Perhaps better to omit if uncertain...?
GoA2019_catch <- GoA2019_catch %>% mutate(scientific_name = ifelse(station == "51" & scientific_name == "Chrysaora melonaster" & species_code_russian == "89190101", "Periphylla periphylla", scientific_name))

GoA2019_catch <- GoA2019_catch %>% mutate(species_code_russian = ifelse(station == "48" & species_code_russian == "8+G342:I3492920152", "82920152", species_code_russian))

# Remove excess columns - please note, keep species_code_russian in there as we need it at later stage.
GoA2019_catch <- GoA2019_catch %>% select(-station)

# For the Gulf of Alaska (GoA2020) catch data:
GoA2020_catch <- read_excel(here("input_datasets", "2020", "2020_GoA_Fish_Trawl_data.xlsx"), 
                            sheet = "CATCH_FINAL")

GoA2020_catch <- GoA2020_catch %>%
  mutate(cruise_name = "IYS2020",
         Vessel_Name_Abbr = "Legacy",
         Zone = NA,
         Event_Type = "Trawl") %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_Name_Abbr, SET_NUMBER, Event_Type, sep = "-"),
         Catch_ID = paste(Station_Event_ID, row_number(), sep = "-")) %>%
  dplyr::rename(common_name = `SPECIES (Description if needed)`,
                catch_weight = `CATCH_WEIGHT (KG)`,
                catch_count = CATCH_NUMBER,
                Scientific_name = SPECIES) %>%
  mutate(catch_weight_units = "kilograms",
         verbatim_identification = Scientific_name,
         Species_recorded = NA,
         Taxonomic_rank = NA,
         Lifestage = NA) %>%
  select(Station_Event_ID, Catch_ID, Species_recorded, Scientific_name, verbatim_identification,
         Taxonomic_rank, Lifestage, common_name, catch_weight, catch_weight_units, catch_count, 
         Comments) %>%
  rename_with(tolower)

# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_catch, TINRO_catch, Shimada_catch, Franklin_catch, GoA2019_catch, GoA2020_catch)

# Combine the catch tables:
IYS_trawl_catch <- bind_rows(TINRO_catch, NW_catch, Shimada_catch, Franklin_catch, GoA2019_catch, GoA2020_catch)

IYS_trawl_catch$dateidentified <- as.character(IYS_trawl_catch$dateidentified)

# Round the catch_count:
IYS_trawl_catch <- IYS_trawl_catch %>% mutate_at(vars(catch_count), funs(round(., 0)))

```

Compare column names between catch data frames. As we want to integrate catch data across the vessels we want to make sure that the taxa are spelled the same way. As such, we'll have _four_ columns for species identification:

1. species_recorded = the original recording of species by data provider: can be either Latin name, common name, or species description.
2. verbatim_identification = original _Latin_ name as provided by the data provider. Can include misspelling.
3. scientific_name = _Latin_ species name of taxa observed, as standardized to the WoRMS Taxonomic Authority. 
4. common_name = Optional. Common names of taxa observed. 

```{r QAQC IYS Catch Data}
# Confirm there are no duplicates in the Catch_ID:
IYS_trawl_catch$catch_id[duplicated(IYS_trawl_catch$catch_id)] # should print character(0)

# Check for closely spelled names that we might have to adjust later:
# TODO: Ensure that any identified names are addressed in code chunk below.
sci_names <- IYS_trawl_catch |> count(scientific_name)

```

Next we want to standardize the taxa observed in the catches across the vessels. We keep the originally recorded Latin name in the column _verbatim_identification_, and the original documentation of the species under _species_recorded_. However, the _scientific_name_ will get standardized to [WoRMS Taxonomic Authority](marinespecies.org).

```{r QAQC species, eval = FALSE}
# Remove " sp." and special characters (i.e. brackets) from scientific_name and adjust spelling: 
IYS_trawl_catch$scientific_name <- gsub("\\b sp.\\b", "", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("[[:punct:]]", "", IYS_trawl_catch$scientific_name)

# Verify there are no special characters and 'sp.' left:
sci_names <- IYS_trawl_catch |> count(scientific_name)

# Some names include lifestages - these need to be parsed in separate columns. 
IYS_trawl_catch <- IYS_trawl_catch %>%
  mutate(lifestage = ifelse(grepl("eggs", IYS_trawl_catch$scientific_name), "eggs", lifestage),
         lifestage = ifelse(grepl("larvae", IYS_trawl_catch$scientific_name), "larvae", lifestage))

# Match the unique recorded species to the WoRMS database.
IYS_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_catch$scientific_name)) %>%
  bind_rows() %>% rename(scientific_name = scientificname) %>%
  select(scientific_name, AphiaID, lsid)

unid_species <- left_join(sci_names, IYS_scientificnames, by = "scientific_name") %>% filter(is.na(AphiaID)) 
unid_species <- unique(unid_species$scientific_name)
unid_species

# # We see that there are 28 species that don't have a match in the WoRMS Registry, these need to be changed in the original dataframe (column: scientific_name).
IYS_trawl_catch$scientific_name <- gsub("Abraliopsis Felis", "Abraliopsis felis", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Chiroteuthis calix", "Chiroteuthis calyx", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Chrysaora melonaster", "Chrysaora melanaster", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Ctenephores", "Ctenophora", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("^Euphausiid$", "Euphausiidae", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Fish eggs", "Pisces", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Flatfish larvae", "Pleuronectiformes", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Glycptocephalus zacharius", "Glyptocephalus zachirus", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Glyptocephalus zachiris", "Glyptocephalus zachirus", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("gonatidae", "Gonatidae", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("goose neck barnacle", "Pollicipes polymerus", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Gooseneck barnacle", "Pollicipes polymerus", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Hormiphora cucumisÃ‚", "Hormiphora cucumis", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("jellyfish", "Cnidaria", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Moroteuthis robusta", "Moroteuthis robustus", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("myctophiids", "Myctophidae", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Paralichthydidae", "Paralichthyidae", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Paralepidadae", "Paralepididae", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Phacellophora sp", "Phacellophora", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Ptereotrachea", "Pterotrachea", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Sergestes similus", "Sergestes similis", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("squid", "Cephalopoda", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Phacellophora camtchatica", "Phacellophora camtschatica", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Argropelecus sladeni", "Argyropelecus sladeni", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Scyphozoa class", "Scyphozoa", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("^Amphipod$", "Amphipoda", IYS_trawl_catch$scientific_name) 
IYS_trawl_catch$scientific_name <- gsub("Onychoteuthis borealijaponicus", "Onychoteuthis borealijaponica", IYS_trawl_catch$scientific_name)

# Remove any potential leading or trailing white space:
IYS_trawl_catch <- IYS_trawl_catch %>% mutate(scientific_name = stringr::str_trim(scientific_name))

# Verify manually:
sci_names <- IYS_trawl_catch |> count(scientific_name)

# Looking at the sci_names dataframe, there are some species that - although have an AphiaID - have slightly different spelling. To improve the interoperability in the IDC, these are changed: 
IYS_trawl_catch$scientific_name <- gsub("Oncorhynchus tschawytscha", "Oncorhynchus tshawytscha", IYS_trawl_catch$scientific_name)
IYS_trawl_catch$scientific_name <- gsub("Symbolophorus californiense", "Symbolophorus californiensis", IYS_trawl_catch$scientific_name)

# Final confirmation that there's no duplicate spelled names:
sci_names <- IYS_trawl_catch |> count(scientific_name)

# Rematch the unique recorded species to the WoRMS registry to ensure all names have been changed appropriately. Check manually because sometimes multiple AphiaIDs are associated to a taxa or species, which need to be removed. 
IYS_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_catch$scientific_name)) %>%
  bind_rows() %>% rename(scientific_name = scientificname)

duplicates <- IYS_scientificnames %>%
  group_by(scientific_name) %>%
  filter(n() > 1) %>%
  select(scientific_name, AphiaID, lsid)
  
IYS_scientificnames <- IYS_scientificnames %>%
  filter(!AphiaID %in% c("1434994", "106331", "163921", "835292")) %>%
  select(scientific_name, AphiaID, lsid)

IYS_trawl_catch <- left_join(IYS_trawl_catch, IYS_scientificnames, by = "scientific_name") %>%
  rename(scientific_name_id = lsid,
         identified_by = identifiedby,
         date_identified = dateidentified) %>%
  select(-AphiaID)

# Some common_names contain lifestages (juv, larvae). Don't remove these lifestages from the common_name, but make sure they are included in the column lifestage. "Eggs" is also included in the common_name, but for this observation 'eggs' was also included in the lifestage. 

IYS_trawl_catch <- IYS_trawl_catch %>%
  mutate(lifestage = ifelse(grepl("larvae", common_name), "larvae", lifestage),
         lifestage = ifelse(grepl("juv", common_name), "juvenile", lifestage))

# Replace larval in the lifestage column by larvae for consistency:
IYS_trawl_catch$lifestage <- gsub("larval", "larvae", IYS_trawl_catch$lifestage)

IYS_trawl_catch |> count(lifestage)
IYS_trawl_catch |> count(taxonomic_rank)

# Remove any unnecessary capitalization to ensure consistency:
IYS_trawl_catch$lifestage <- tolower(IYS_trawl_catch$lifestage)
IYS_trawl_catch$taxonomic_rank <- tolower(IYS_trawl_catch$taxonomic_rank)
IYS_trawl_catch$catch_weight_units <- tolower(IYS_trawl_catch$catch_weight_units)

# Change larval to larvae in the lifestage column:
IYS_trawl_catch$lifestage <- gsub("larval", "larvae", IYS_trawl_catch$lifestage)

# Currently the IYS_trawl_catch contains column 'species_code_russian'; we need this at a later stage to QAQC 2019 trawl data and properly merge. However, we don't need it in the output table for the Integrated Data Collection:
IYS_trawl_all <- IYS_trawl_catch %>% select(-species_code_russian)

# Remove empty columns and replace NA by blank cells:
IYS_trawl_all <- IYS_trawl_all %>% mutate(across(is.character,~na_if(trimws(.),""))) %>%
   remove_empty("cols")

# Rename alternative_event_id and alternative_catch_id to original_event_id and original_catch_id, respectively, and change the order of columns:
IYS_trawl_all <- IYS_trawl_all %>%
  rename(original_event_id = alternative_event_id,
         original_catch_id = alternative_catch_id) %>%
  dplyr::select(station_event_id, original_event_id, catch_id, original_catch_id,
                everything())

# Noticed some inconsistencies in count_method. Resolving this after contacting respective data providers:
IYS_trawl_all$count_method <- gsub("Count", "Total", IYS_trawl_all$count_method)
IYS_trawl_all$count_method <- gsub("Subsample", "Weight estimate", IYS_trawl_all$count_method)
IYS_trawl_all$count_method <- gsub("Estimate", "Visual estimate", IYS_trawl_all$count_method)

# Reorder column names:
trawl_col_order <- c("station_event_id", "original_event_id", "catch_id", "original_catch_id",
                     "verbatim_identification", "species_recorded", "common_name", "scientific_name",
                     "scientific_name_id", "taxonomic_rank", "identified_by", "date_identified", "lifestage",
                     "catch_count", "count_method", "catch_weight", "catch_weight_units", "weight_method",
                     "comments")

IYS_trawl_all <- IYS_trawl_all[, trawl_col_order]

IYS_trawl_all <- sapply(IYS_trawl_all, as.character)
IYS_trawl_all[is.na(IYS_trawl_all)] <- ""
IYS_trawl_all <- as_tibble(IYS_trawl_all)

# Save catch data:
write_csv(IYS_trawl_all, here("output_datasets", "IYS_trawl_catch.csv"))
```

## Specimen Data

Now let's join the overall specimen data from these vessels into a specific data frame as well. Cleaning specimen columns:

```{r specimen clean}
#TODO: Integrate age data
#TODO: Integrate genetic stock ID data

# For NW Explorer Specimen data:
NW_specimen <- read_excel(here("input_datasets", "2022", "IYS2022_NW_Data.xlsx"), sheet = "Specimen_Info")

# Marks_scars column contains information on visceral adhesion as well. Make sure to parse this out into a separate column and remove from the original column. 
NW_specimen <- NW_specimen %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Specimen_ID = `Specimen ID`,
                Specimen_Length = Length,
                Specimen_Weight = Weight,
                original_specimen_id = Barcode) %>%
  rename_with(tolower) %>%
  mutate(verbatim_identification = scientific_name) %>%
  mutate(visceral_adhesion = case_when(
         marks_scars == "Visceral Adhesion" ~ "yes")) %>%
  mutate(marks_scars = gsub("Visceral Adhesion", "", marks_scars)) %>%
  select(-`alternate id`)

# Remove Can from the station_event_id, catch_id and specimen_id:
NW_specimen$station_event_id <- gsub("Can", "", NW_specimen$station_event_id)
NW_specimen$catch_id <- gsub("Can", "", NW_specimen$catch_id)
NW_specimen$specimen_id <- gsub("Can", "", NW_specimen$specimen_id)

# Make the original_specimen_id a character:
NW_specimen$original_specimen_id <- as.character(NW_specimen$original_specimen_id)

# For TINRO Specimen data:
TINRO_specimen <- read_excel(here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), sheet = "6. SPECIMEN INFO")

TINRO_specimen <- TINRO_specimen %>% rename_with(tolower) %>%
  select(-c(fin_clip, gill:`scale num`, head:note)) %>%
  mutate(verbatim_identification = scientific_name) %>%
  rename(original_specimen_id = dna,
         marks_scars = `marks/scars`,
         visceral_adhesion = `visceral adhesion`)

# If visceral_adhesion = 1, change to 'yes'. 
TINRO_specimen$visceral_adhesion <- ifelse(TINRO_specimen$visceral_adhesion == "1",
                                           "yes", "no")

# For Shimada specimen data:
Shimada_specimen <- read_excel(here("input_datasets", "2022", "IYS2022_Shimada_Data.xlsx"), sheet = "6. SPECIMEN INFO")

Shimada_scars <- read_excel(here("input_datasets", "2022", "IYS2022_Shimada_MarksScars_Data.xlsx"), sheet = "Sheet1")
Shimada_scars <- Shimada_scars %>%
  rename(original_specimen_id = `Bar code`) %>%
  select(original_specimen_id, `Sticky guts`, `Scar/wound`)

# Add dummy columns for visceral_adhesion and marks_scars until these can be populated:
Shimada_specimen <- Shimada_specimen %>% rename_with(tolower) %>%
  rename(original_specimen_id = `barcode number`)
Shimada_specimen <- left_join(Shimada_specimen, Shimada_scars, by = "original_specimen_id")
Shimada_specimen <- Shimada_specimen %>%
  mutate(verbatim_identification = scientific_name) %>%
  rename(visceral_adhesion = `Sticky guts`,
         marks_scars = `Scar/wound`)

# Change y and n to yes and no respectively to improve interoperability:
Shimada_specimen$visceral_adhesion <- ifelse(Shimada_specimen$visceral_adhesion == "y", "yes", Shimada_specimen$visceral_adhesion)
Shimada_specimen$visceral_adhesion <- ifelse(Shimada_specimen$visceral_adhesion == "n", "no", Shimada_specimen$visceral_adhesion)

Shimada_specimen$original_specimen_id <- as.character(Shimada_specimen$original_specimen_id)

# For Franklin specimen data:
Franklin_specimen <- read_excel(here("input_datasets", "2022", "IYS2022_Franklin_Data.xlsx"), 
                                sheet = "5. SPECIMEN INFO")

# Add dummy columns for visceral_adhesion and marks_scars until these can be populated:
Franklin_specimen <- Franklin_specimen %>% rename_with(tolower) %>%
  dplyr::rename(original_event_id = dfo_station_event_id,
                original_catch_id = dfo_catch_id,
                original_specimen_id = dfo_specimen_id,
                lifestage = age_class) %>%
  select(-specimenid) %>%
  mutate(verbatim_identification = scientific_name,
         visceral_adhesion = NA,
         marks_scars = NA)

Franklin_specimen$specimen_length <- as.numeric(Franklin_specimen$specimen_length)
Franklin_specimen$specimen_weight <- as.numeric(Franklin_specimen$specimen_weight)
```

Clean the GoA2019 and GoA2020 Specimen data to integrate with 2022 data:

```{r GOA2019 specimen clean}
GoA2019_specimen <- read_excel(here("input_datasets", "2019",
                                    "JuvSalmon_2019-01_Specimens_v21.01b_SUBMITTED_COPY.xlsx"), 
                               sheet = "SPECIMEN_FINAL")

GoA2019_specimen <- GoA2019_specimen %>%
  mutate(cruise_name = "IYS2019",
         Vessel_name_abbr = "Kaganovsky", 
         Zone = NA,
         Event_Type = "Trawl",
         data_type = "specimen",
         Scientific_Name = paste(genus, species, sep = " "),
         worms_scientific_name = paste(genus, species, sep = " ")) %>% 
  dplyr::rename(Station = TOW_NUMBER,
                common_name = `common name`,
                species_code_russian = `SPECIES CODE (Russian)`) %>%
  select(Station, common_name, LENGTH, SEX_CODE, `WEIGHT - TOTAL`, cruise_name, Vessel_name_abbr, Zone, Scientific_Name, Event_Type,
         data_type, species_code_russian)

GoA2019_specimen$species_code_russian <- as.character(GoA2019_specimen$species_code_russian)

GoA2019_specimen <- GoA2019_specimen %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_name_abbr, Station, Event_Type, sep = "-"))

# We want to compare the catch and the specimen data tables by joining them by Station_Event_ID and Scientific_Name. Therefore, we have to ensure that the spelling of Scientific_Names at least matches between these data frames (regardless of whether it is accurately represented in WORMS)
specimen_unique <- unique(GoA2019_specimen$Scientific_Name)
catch_unique <- unique(GoA2019_catch$scientific_name)

setdiff(specimen_unique, catch_unique)

# You can notice that in the specimen data, species names' are often followed by Russian (e.g. Ð¿Ð¾Ð»Ð¾Ð².). We need to remove these as otherwise we can't properly connect the catch to the specimen data. 
GoA2019_specimen$Scientific_Name <- gsub("[()]", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" Ð½ÐµÐ¿Ð¾Ð»Ð¾Ð².", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" ÑÐµÐ³Ð¾Ð».", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" Ð¿Ð¾Ð»Ð¾Ð².", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" Ð¼Ð¾Ð».", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub("\\b sp. 1\\b|\\b sp.\\b", "", GoA2019_specimen$Scientific_Name)

GoA2019_catch$scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", GoA2019_catch$scientific_name)

GoA2019_specimen <- GoA2019_specimen %>%
  rename_with(tolower)

#Some specimen data have a species_code that is not reflected in the catch_data. As a result, these do not get matched up properly. As such, for now, I'll make some changes to the species_code in the specimen_data so that these rows can get properly matched with the catch data. 
#TODO: Confirm with data provider (C. Neville) and consider making these changes in the specimen data file. 
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "5" & species_code_russian == "82920152", "82920102", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "12" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "13" & species_code_russian == "82920152", "82920102", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "29" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "30" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "32" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "35" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "36" & species_code_russian %in% c("14350419", "14350411"), "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "44" & species_code_russian %in% c("14340419", "14350411"), "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "45" & species_code_russian == "14350419", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(scientific_name = ifelse(station == "52" & species_code_russian == "80880402", "Calycopsis", scientific_name))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & species_code_russian == "82920102", "82920152", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & scientific_name == "Gonatus onyx", "82920257", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & species_code_russian == "14350414", "14350417", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "59" & species_code_russian == "82920152", "13231901", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(scientific_name = ifelse(station == "62" & species_code_russian == "13660101", "Lestidium ringens", scientific_name))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "64" & species_code_russian == "82920102", "82920152", species_code_russian))

# Left join to the GoA2019_catch data table so that we can create the specimen_IDs
merge <- left_join(GoA2019_catch, GoA2019_specimen, by = c("station_event_id", "scientific_name", "species_code_russian"))
merge <- merge %>% group_by(catch_id) %>% 
  mutate(specimen_id = paste(catch_id, row_number(), sep = "-")) %>%
  ungroup()

GoA2019_specimen_tab <- merge %>% filter(data_type == "specimen") %>%
  dplyr::rename(specimen_length = length,
                specimen_weight = `weight - total`,
                sex = sex_code) %>%
  select(station_event_id, catch_id, specimen_id, species_recorded, scientific_name, lifestage, specimen_length,
         specimen_weight, sex) %>%
  mutate(length_units = "millimeters",
         weight_units = "grams") 

# Add length_type for species, as per conversation with CN. 
GoA2019_specimen_tab <- GoA2019_specimen_tab %>%
  mutate(length_type = case_when(
    .$scientific_name %in% c("Hormiphora cucumis", "Salpa sp.", "Ctenephores sp.", "Thysanoessa spinifera", "Aurelia labiata", "Chrysaora melonaster", "Calycopsis sp.", "Paralepididae gen. sp. 1", "Siphonophora sp.", "Microstomus pacificus", "Tarletonbeania crenularis", "Corolla calceola", "Squalus suckleyi", "Thalassenchelys coheni", "Sergestes similis", "Aptocyclus ventricosus", "Sebastes melanops", "Anotopterus nikparini", "Zaprora silenus", "Gasterosteus aculeatus", "Thetys vagina") ~ "Total length",
    .$scientific_name %in% c("Lestidium ringens", "Oncorhynchus gorbuscha", "Oncorhynchus kisutch", "Oncorhynchus keta", "Oncorhynchus nerka", "Oncorhynchus tschawytscha", "Icichthys lockingtoni") ~ "Fork length",
    .$scientific_name %in% c("Symbolophorus californiense", "Stenobrachius leucopsarus", "Diaphus theta", "Lipolagus ochotensis") ~ "Standard length",
    .$scientific_name %in% c("Phacellophora camtshchatica", "Aurelia limbata", "Periphylla periphylla") ~ "Bell diameter",
    .$scientific_name %in% c("Gonatus sp.", "Gonatidae sp.", "Boreoteuthis borealis", "Gonatus onyx", "Onychoteuthis borealijaponica", "Abraliopsis felis", "Japetella diaphana", "Moroteuthis robusta", "Belonella borealis", "Gonatus madokai", "Chiroteuthis calyx") ~ "Mantle length"))

spp_sci_names <- GoA2019_specimen_tab |> count(scientific_name)

GoA2019_specimen_tab$sex <- tolower(GoA2019_specimen_tab$sex)
GoA2019_specimen_tab <- GoA2019_specimen_tab %>%
  mutate(lifestage = ifelse(sex == "j", "juvenile", lifestage),
         lifestage = ifelse(sex == "3.0", "mature", lifestage),
         lifestage = ifelse(sex == "1.0", "immature", lifestage)) #TODO: confirm 1.0 is indeed immature.

# Remove these from the sex column, as they are now included in the lifestage column:
GoA2019_specimen_tab$sex <- gsub("j|3.0|1.0", "", GoA2019_specimen_tab$sex)

GoA2019_specimen_tab <- GoA2019_specimen_tab %>%
  mutate(sex = ifelse(sex == "n", "unknown", sex),
         sex = ifelse(sex == "f", "female", sex),
         sex = ifelse(sex == "m", "male", sex))

# Add dummy columns for visceral_adhesion and marks_scars:
GoA2019_specimen_tab$marks_scars <- NULL
GoA2019_specimen_tab$visceral_adhesion <- NULL

```

Clean the GoA2020 Trawl specimen data to integrate with other trawl/specimen data:

```{r GOA2020 specimen clean}
GoA2020_specimen <- read_excel(here("input_datasets", "2020",
                                    "2020-01 Specimen file.v21.1c_FINAL SUBMIT_jan18_2021.xlsx"), 
                            sheet = "SPECIMEN_FINAL")

GoA2020_specimen <- GoA2020_specimen %>%
  mutate(cruise_name = "IYS2020",
         Vessel_name_abbr = "Legacy", 
         Zone = NA,
         Event_Type = "Trawl",
         data_type = "specimen") %>%
  mutate(station_event_id = paste(cruise_name, Vessel_name_abbr, SET_NUMBER, Event_Type, sep = "-")) %>%
  select(station_event_id, data_type, SET_NUMBER, SPECIES, SPECIES_DESCRIPTION, `LENGTH (FORK) - mm`, `LENGTH (STANDARD) - mm`, `LENGTH (TOTAL)`, 
         `LENGTH (MANTLE) - cm`, `WEIGHT - ROUND (g)`, SEX, `DEVELOPMENTAL STAGE`, COMMENTS) %>%
  dplyr::rename(scientific_name = SPECIES,
                lifestage = `DEVELOPMENTAL STAGE`)

# We want to compare the catch and the specimen data tables by joining them by Station_Event_ID and Scientific_Name. Therefore, we have to ensure that the spelling of Scientific_Names at least matches between these data frames (regardless of whether it is accurately represented in WORMS)
specimen_unique <- unique(GoA2020_specimen$scientific_name)
catch_unique <- unique(GoA2020_catch$scientific_name)

setdiff(specimen_unique, catch_unique)

# There are 7 taxa whose names have to be adjusted between the catch and specimen data to align them:
# Paralepididae, Oncorhynchus gorbusha, Pterotrachea sp., Phacellophoroa camtschatica, Dosidicus gigas?, Calycopsis, Unknown jelly
GoA2020_specimen$scientific_name <- gsub("Paralepididae", "Paralepidadae", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Oncorhynchus gorbusha", "Oncorhynchus gorbuscha", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Pterotrachea sp.", "Ptereotrachea sp.", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Phacellophoroa camtschatica", "Phacellophora camtschatica", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("\\?", "", GoA2020_specimen$scientific_name) # To remove the ? from Dosidicus gigas
GoA2020_specimen$scientific_name <- gsub("Calycopsis", "Calycopsis sp.", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Unknown jelly", "jellyfish", GoA2020_specimen$scientific_name)

# Confirm no different in species names between catch data and specimen data:
specimen_unique <- unique(GoA2020_specimen$scientific_name)
catch_unique <- unique(GoA2020_catch$scientific_name)
setdiff(specimen_unique, catch_unique) # should be character(0)

# Left join to the GoA2019_catch data table so that we can create the specimen_IDs
merge <- left_join(GoA2020_catch, GoA2020_specimen, by = c("station_event_id", "scientific_name", "lifestage"))
merge <- merge %>% group_by(catch_id) %>% 
  mutate(specimen_id = paste(catch_id, row_number(), sep = "-")) %>%
  ungroup()

GoA2020_specimen_tab <- merge %>% filter(data_type == "specimen") %>% select(-comments) %>%
  mutate(specimen_length = ifelse(
    !is.na(`LENGTH (FORK) - mm`), `LENGTH (FORK) - mm`, ifelse(
    !is.na(`LENGTH (STANDARD) - mm`), `LENGTH (STANDARD) - mm`, ifelse(
    !is.na(`LENGTH (TOTAL)`), `LENGTH (TOTAL)`, ifelse(
    !is.na(`LENGTH (MANTLE) - cm`), `LENGTH (MANTLE) - cm`, NA)))))  

# Check to see if it works:
manual_check <- GoA2020_specimen_tab %>% select(`LENGTH (FORK) - mm`, `LENGTH (STANDARD) - mm`, `LENGTH (TOTAL)`, `LENGTH (MANTLE) - cm`, specimen_length)

# Notice how sometimes multiple length measurements are given (i.e. both fork and standard). We have to account for this:

GoA2020_specimen_tab <- GoA2020_specimen_tab %>%
  mutate(specimen_length2 = ifelse(!is.na(`LENGTH (FORK) - mm`) & !is.na(`LENGTH (STANDARD) - mm`), `LENGTH (STANDARD) - mm`, NA)) %>%
  mutate(length_type = case_when(`LENGTH (FORK) - mm` > 0 ~ "Fork Length",
                                 `LENGTH (STANDARD) - mm` > 0 ~ "Standard Length",
                                 `LENGTH (TOTAL)` > 0 ~  "Total Length",
                                 `LENGTH (MANTLE) - cm` > 0 ~ "Bell Diameter"),
         length_type2 = case_when(`LENGTH (FORK) - mm` > 0 & `LENGTH (STANDARD) - mm` > 0 ~ "Standard Length"),
         length_units = case_when(`LENGTH (FORK) - mm` > 0 ~ "millimeters",
                                  `LENGTH (STANDARD) - mm` > 0 ~ "millimeters",
                                  `LENGTH (TOTAL)` > 0 ~ "millimeters",
                                  `LENGTH (MANTLE) - cm` > 0 ~ "centimeters"))

GoA2020_specimen_tab <- GoA2020_specimen_tab %>%
  dplyr::rename(specimen_weight = `WEIGHT - ROUND (g)`) %>%
  mutate(weight_units = "grams") %>%
  rename_with(tolower) %>%
  select(station_event_id, catch_id, specimen_id, verbatim_identification, species_recorded, scientific_name, taxonomic_rank,
         lifestage, common_name, specimen_length, specimen_length2, length_type, length_units, length_type2, specimen_weight,
         weight_units, sex, comments)

# Change class for columns:
GoA2020_specimen_tab$specimen_length <- as.numeric(GoA2020_specimen_tab$specimen_length)
GoA2020_specimen_tab$specimen_length2 <- as.numeric(GoA2020_specimen_tab$specimen_length2)
GoA2020_specimen_tab$sex <- as.character(GoA2020_specimen_tab$sex)

# Add dummy columns for visceral_adhesion and marks_scars for interoperability:
GoA2020_specimen_tab$marks_scars <- NULL
GoA2020_specimen_tab$visceral_adhesion <- NULL
```

Join the specimen data rows. 

```{r All specimen Data}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_specimen, TINRO_specimen, Shimada_specimen, Franklin_specimen, 
                         GoA2019_specimen_tab, GoA2020_specimen_tab)

# Bind rows and save: 
IYS_trawl_specimen <- bind_rows(TINRO_specimen, NW_specimen, Shimada_specimen, Franklin_specimen,
                                GoA2019_specimen_tab, GoA2020_specimen_tab)

# Change length_units 'Centimeters' to 'Millimeters' and change the length measurement accordingly:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(specimen_length = ifelse(length_units == "Centimeters", specimen_length * 10, specimen_length),
         length_units = "Millimeters")

# Make the lifestages all lowercase, so we don't have both Adult and adult:
IYS_trawl_specimen$lifestage <- tolower(IYS_trawl_specimen$lifestage)

# Change some of the sex to make integration easier:
IYS_trawl_specimen$sex <- tolower(IYS_trawl_specimen$sex)
sex <- unique(IYS_trawl_specimen$sex)

# From 2020 specimen metadata the following inferences are made:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(sex = ifelse(sex == "n", "unknown", sex),
         sex = ifelse(sex == "1", "male", sex),
         sex = ifelse(sex == "2", "female", sex),
         sex = ifelse(sex == "3", "unsexed", sex),
         sex = ifelse(sex == "?", "unknown", sex),
         sex = ifelse(sex == "m", "male", sex),
         sex = ifelse(sex == "f", "female", sex),
         sex = ifelse(sex == "f?", "female?", sex))

# Indicate that specimen_length_units and specimen_length2_units
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  rename(specimen_length_units = length_units) %>%
  mutate(specimen_length2_units = ifelse(!is.na(length_type2), specimen_length_units, NA))

# Change specimen_weight to reflect grams, and ensure that weight_units = Grams:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(specimen_weight = ifelse(weight_units %in% c("Kilograms", "kilograms"), 
                                  specimen_weight * 1000, specimen_weight),
         weight_units = "Grams")
```

In the next section, we do basic quality control on the specimen data to ensure interoperability across vessels:

```{r QAQC specimen data, eval = FALSE}
# Confirm no duplicates in Specimen_ID:
IYS_trawl_specimen$specimen_id[duplicated(IYS_trawl_specimen$specimen_id)] # should print character(0)

specimen_names <- IYS_trawl_specimen |> 
  count(scientific_name)

# Ensure any lifestages from the scientific names are included in the lifestage column:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(lifestage = ifelse(grepl("larvae", scientific_name), "larvae", lifestage))

# Remove " sp." and special characters (i.e. brackets) from scientific_name and adjust spelling: 
IYS_trawl_specimen$scientific_name <- gsub("\\b sp.\\b", "", IYS_trawl_specimen$scientific_name)

# Match the unique recorded species to the WoRMS database. Check manually because sometimes multiple AphiaIDs are associated, which need to be removed.
IYS_spp_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_specimen$scientific_name)) %>% bind_rows() %>%
  rename(scientific_name = scientificname)

unid_species <- left_join(IYS_trawl_specimen, IYS_spp_scientificnames, by = "scientific_name") %>% 
  filter(is.na(AphiaID)) %>%
  distinct(scientific_name)

# We see that in the overall catch data there are 9 (including 'NA') species that don't have a match in the WoRMS Registry, change these names in the original dataframe. Please note that Oncorhynchus tschawythscha does get an AphiaID, but WoRMS indicates that the spelling is wrong. 
IYS_trawl_specimen$scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Phacellophora camtchatica", "Phacellophora camtschatica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Hormiphora cucumisÃ‚", "Hormiphora cucumis", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Moroteuthis robusta", "Moroteuthis robustus", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Chrysaora melonaster", "Chrysaora melanaster", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Paralepidadae", "Paralepididae", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Abraliopsis Felis", "Abraliopsis felis", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Ptereotrachea", "Pterotrachea", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Chiroteuthis calix", "Chiroteuthis calyx", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Glycptocephalus zacharius", "Glyptocephalus zachirus", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("jellyfish", "Cnidaria", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Flatfish larvae", "Pleuronectiformes", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Argropelecus sladeni", "Argyropelecus sladeni", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Onychoteuthis borealijaponicus", "Onychoteuthis borealijaponica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Oncorhynchus tschawytscha", "Oncorhynchus tshawytscha", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Symbolophorus californiense", "Symbolophorus californiensis", IYS_trawl_specimen$scientific_name)

IYS_trawl_specimen <- IYS_trawl_specimen %>% mutate(scientific_name = stringr::str_trim(scientific_name))

# Check for duplicates names again:
specimen_names <- IYS_trawl_specimen |> 
  count(scientific_name)

# Check manually because sometimes multiple AphiaIDs are associated to a taxa or species, which need to be removed. 
IYS_spp_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_specimen$scientific_name)) %>% bind_rows() %>% 
  rename(scientific_name = scientificname)

# Define the duplicates:
duplicates <- IYS_spp_scientificnames %>%
  group_by(scientific_name) %>%
  filter(n() > 1) %>%
  select(scientific_name, AphiaID, lsid)

# Remove the AphiaIDs that are not applicable:
IYS_spp_scientificnames <- IYS_spp_scientificnames %>% 
  filter(!AphiaID %in% c("1434994", "106331", "163921")) %>%
  select(scientific_name, AphiaID, 
         scientific_name_id = lsid)

# As per earlier discussions, we won't be including gonad, fat, etc measurements in the specimen tab. 
IYS_trawl_specimen <- left_join(IYS_trawl_specimen, IYS_spp_scientificnames, by = "scientific_name") %>%
  select(-c(AphiaID, alternative_id, stomach_fullness, gonad_weight_grams, `weight_units...11`,
            `fat reading 1`, `fat reading 2`, `fat reading 3`, `fat reading units`, `gonad weight`,
            `weight_units...19`, species_updated, scalecard_position, scale_pref_code, institutioncode,
            institutionid, collectioncode))

# Make taxonomic_rank all lower case:
IYS_trawl_specimen$taxonomic_rank <- tolower(IYS_trawl_specimen$taxonomic_rank)

# Change Mantle Length-squid to 'Mantle length' and apply str_to_title() function
IYS_trawl_specimen$length_type <- gsub("-squid", "", IYS_trawl_specimen$length_type)
IYS_trawl_specimen$length_type <- stringr::str_to_title(IYS_trawl_specimen$length_type)

length_types <- IYS_trawl_specimen |> count(length_type)

# Remove empty columns and replace NA by blank cells:
IYS_trawl_specimen <- IYS_trawl_specimen %>% mutate(across(is.character,~na_if(trimws(.),""))) %>%
   remove_empty("cols")

# Reorder column names:
spp_col_order <- c("station_event_id", "original_event_id", "catch_id", "original_catch_id", "specimen_id",
                   "original_specimen_id", "verbatim_identification", "species_recorded", "common_name", 
                   "scientific_name", "scientific_name_id", "lifestage", "sex", "taxonomic_rank", "size_class_mm",
                   "number_measured", "specimen_length", "specimen_length_units", "length_type", 
                   "specimen_length2", "specimen_length2_units", "length_type2", "specimen_weight", "specimen_weight2",
                   "weight_units", "weight_type", "marks_scars", "visceral_adhesion", "comments")
IYS_trawl_specimen <- IYS_trawl_specimen[, spp_col_order]

IYS_trawl_specimen <- sapply(IYS_trawl_specimen, as.character)
IYS_trawl_specimen[is.na(IYS_trawl_specimen)] <- ""
IYS_trawl_specimen <- as_tibble(IYS_trawl_specimen)

# Check for any relational issues:
rel_issues <- dplyr::anti_join(IYS_trawl_specimen, IYS_trawl_catch, by = "catch_id")

# Save specimen data:
write_csv(IYS_trawl_specimen, here("output_datasets", "IYS_trawl_specimen.csv"))
```

Next, add the Bongo Specimen data. The source files for this integrated data collection tab are:
`IYSZoopAbund2019_2020Long.csv` -- file sent by Joanne Breckenridge (UBC) with the latest version of the taxonomic abundance data from the 2019 and 2020 High Seas Expeditions. This file has been corrected following revisions sent by Joanne (file: `IYSKaganoSpecRemovedfromNet.csv`). 
`IYS2022_Zooplankton_Template.xlsx` -- file generated through the script 2022-TINRO-Bongo-script.Rmd, found [here](https://github.com/international-year-of-the-salmon/2022-IYS-Bongo/tree/main/scripts). This script uses the source files: 
`7-14 2022 Bongo Logbook-TINRO_clean.xlsx` - Bongo taxonomic abundance data from the TINRO
`IYS2022_Shimada_NW_Zooplankton.xlsx` - Bongo taxonomic abundance data from the Shimada and NW Explorer, standardized to a template.
`2022002 IYS Franklin abund biomass by species n life stage.xlsx` - Bongo taxonomic abundance data from the Franklin.

# Zooplankton

```{r Zooplankton}
zoop_2019_2020 <- read_csv(here("input_datasets", "2019", "IYSZoopAbund2019_2020Long.csv"))
zoop_2019_2020 <- zoop_2019_2020[, -1]

zoop_2019_2020[1] <- lapply(zoop_2019_2020[1], function (x) {
  x1 <- type.convert(as.character(x), as.is = TRUE) 
  ifelse(grepl("^[0-9.]+$", x1), round(as.numeric(x1)), x1)
})

zoop_2019_2020$sf_proc <- gsub("10-May", "5-10", zoop_2019_2020$sf_proc)

zoop_2019_2020 <- zoop_2019_2020 %>%
  dplyr::select(station,
         date,
         flowmeter_volume_filtered_m3 = vol_flow_est,
         depth_volume_filtered_m3 = vol_depth_est,
         comments = notes, 
         prop_total_sample,
         sf_proc,
         prop_sf_proc,
         lifestage = stage, 
         sex, genus, species,
         verbatim_identification = id,
         abund_m3_flow_est,
         abund_m3_depth_est,
         catch_count = ind_total)

# Some abundance_m3 values are negative. As per Joanne Breckenridge (UBC): "flowmeter-estimated volume is less than 50% of depth-estimated volume, we use the depth-estimated volume to calculate abundance."
zoop_2019_2020 <- zoop_2019_2020 %>%
  mutate(abundance_m3 = ifelse(abund_m3_flow_est >= 0, abund_m3_flow_est, abund_m3_depth_est)) %>%
  mutate(comments = ifelse(abund_m3_flow_est >= 0, comments, 
                           "Depth-estimated volume was used to calculate abundance")) %>%
  select(-c(abund_m3_flow_est, abund_m3_depth_est))

# Some entries in the species column depict a lifestage:
zoop_2019_2020 <- zoop_2019_2020 %>%
  mutate(lifestage = ifelse(grepl("C1", zoop_2019_2020$species), "C1", lifestage),
         lifestage = ifelse(grepl("C2", zoop_2019_2020$species), "C2", lifestage),
         lifestage = ifelse(grepl("C3", zoop_2019_2020$species), "C3", lifestage))

# For some observations, no species was reported, only an id (=verbatim_identification). Make sure the scientific_name column gets populated with verbatim_identification if otherwise empty.
zoop_2019_2020 <- zoop_2019_2020 %>%
  mutate(species = gsub("C1|C2|C3", "", zoop_2019_2020$species),
         scientific_name = verbatim_identification)

zoop_2019_2020 <- zoop_2019_2020 %>%
  mutate(net_number = "1",
         station_event_id = ifelse(grepl("2019", date), 
                                   paste("GoA2019", "Kaganovsky", station, "Bongo", sep = "-"),
                                   paste("GoA2020", "Legacy", station, "Bongo", sep = "-")),
         net_id = paste(station_event_id, net_number, sep = "-")) %>%
  group_by(station_event_id) %>%
  mutate(specimen_id = paste(net_id, row_number(), sep = "-"),
         species_recorded = NA,
         preservation_method = "Formalin",
         identified_by = NA,
         common_name = NA,
         date_identified = NA, 
         size_range = NA, 
         count_method = NA) %>%
  select(-c(station, date, genus, species)) %>%
  ungroup()

dups <- zoop_2019_2020 %>% group_by(net_id) %>% filter(n() >1)

zoop_2022 <- read_excel(here("input_datasets", "2022", "IYS2022_Zooplankton_Template.xlsx"), 
                   sheet = "Bongo_Specimen_Data")

# Need to recreate the station_event_id, catch_id and specimen_id columns:
zoop_2022 <- zoop_2022 %>%
  rename(specimen_id = catch_id, 
         net_id = station_event_id) %>%
  mutate(station_event_id = sub('-[^-]*$', '', net_id))

zoop_2022 <- zoop_2022 %>% select(-taxonomic_rank) %>%
  rename(verbatim_identification = verbatimIdentification) %>%
  mutate(species_recorded = NA)

janitor::compare_df_cols(zoop_2019_2020, zoop_2022)

zoop <- rbind(zoop_2019_2020, zoop_2022)

# For IYS2019-Kaganovsky-8-Bongo-1-36, change lifestage to "juvenile"
zoop$lifestage[zoop$specimen_id == "IYS2019-Kaganovsky-8-Bongo-1-36"] <- "juvenile"
zoop$sex <- gsub("juvenile", "", zoop$sex)

# Some size_ranges include lifestages, parse these into the correct column and remove from size_range column:
zoop$lifestage <- ifelse(grepl("Megalopa", zoop$size_range), "megalopae", zoop$lifestage)

# Remove these lifestages from the size_range column
zoop$size_range <- gsub("fur |Megalopa", "", zoop$size_range)

# Standardize the lifestage column:
zoop$lifestage <-  gsub("calyptopsis|^cal$|caliptopis", "calyptopis", zoop$lifestage)
zoop$lifestage <-  gsub("furcillia", "furcilia", zoop$lifestage)
zoop$lifestage <-  gsub("^I$", "C1", zoop$lifestage)
zoop$lifestage <-  gsub("^II$", "C2", zoop$lifestage)
zoop$lifestage <-  gsub("^III$", "C3", zoop$lifestage)
zoop$lifestage <-  gsub("^IV$", "C4", zoop$lifestage)
zoop$lifestage <-  gsub("^V$", "C5", zoop$lifestage)
zoop$lifestage <-  gsub("^IVV$", "C4-C5", zoop$lifestage)
zoop$lifestage <-  gsub("C4C5", "C4-C5", zoop$lifestage)
zoop$lifestage <-  gsub("napulius", "nauplius", zoop$lifestage)
zoop$lifestage <-  gsub("C15", "C1-C5", zoop$lifestage) 
zoop$lifestage <-  gsub("C56", "C5-C6", zoop$lifestage) 
zoop$lifestage <-  gsub("Adult", "adult", zoop$lifestage)
zoop$lifestage <-  gsub("larvae", "larva", zoop$lifestage)
zoop$lifestage <-  gsub("floats", "float", zoop$lifestage)

# Standardize the sex column:
zoop <- zoop %>%
  mutate(sex = gsub("^M$", "male", sex),
         sex = gsub("^F$", "female", sex), 
         sex = gsub("^f$", "female", sex))

# Remove " sp." and special characters (i.e. brackets) from scientific_name and adjust spelling: 
zoop$scientific_name <- gsub("\\b sp.\\b|\\b spp.\\b", "", zoop$scientific_name)

# In the species_recorded column there are sometimes lifestages recorded; we want to make sure all of these are captured in the lifestage column. After a manual check, this is only not the case for cyphonautes:
species_recorded <- zoop %>% select(species_recorded, verbatim_identification, lifestage) %>% unique()

#TODO: And 'bracts'?
zoop$lifestage <- ifelse(grepl("cyphonautes", zoop$species_recorded), "cyphonautes", zoop$lifestage)

# For some scientific names, a lifestage is included in the name. After manual check, we see that these lifestages have also been included in a separate column and so we can remove them from scientific_name:
zoop$scientific_name <- gsub("juvenile|nauplius|calyptopsis|egg|furcillia|naplius|larva",
                             "", zoop$scientific_name)

# WoRMS - quick workaround: wm_records_name throws an error when dealing with our unique species list (n=333) as it says it's too long. Breaking it up in 2 separate lists seems to make it work. Issue generated here: https://github.com/ropensci/worrms/issues/39
zoop$scientific_name <- trimws(zoop$scientific_name, "r")
sci_names <- unique(zoop$scientific_name) %>% as.data.frame()
colnames(sci_names)[1] <- "scientificname"
sci_names_1 <- sci_names[1:100,]
sci_names_2 <- sci_names[101:200,]
sci_names_3 <- sci_names[201:333,]

worms_id_1 <- worrms::wm_records_names(sci_names_1, marine_only = T) %>% dplyr::bind_rows()
worms_id_2 <- worrms::wm_records_names(sci_names_2, marine_only = T) %>% dplyr::bind_rows()
worms_id_3 <- worrms::wm_records_names(sci_names_3, marine_only = T) %>% dplyr::bind_rows()
worms_id <- bind_rows(worms_id_1, worms_id_2, worms_id_3)

unid_species <- left_join(sci_names, worms_id, by = "scientificname") %>% 
  filter(is.na(AphiaID)) %>%
  distinct(scientificname)

# So looks like there are 37 species whose names don't show up in the WoRMS Registry. To ensure interoperability across vessels, we standardize all names to match the names in WoRMS, so we change the names in the original dataframe:
zoop$scientific_name <- gsub("^Chaetognath$", "Chaetognatha", zoop$scientific_name)
zoop$scientific_name <- gsub("Chaetognath sp. (no heads)", "Chaetognatha", zoop$scientific_name, fixed = TRUE)
zoop$scientific_name <- gsub("Disconchoecia elegans", "Discoconchoecia elegans", zoop$scientific_name)
zoop$scientific_name <- gsub("^Euphausiid$", "Euphausiidae", zoop$scientific_name)
zoop$scientific_name <- gsub("^Doliolid$", "Doliolidae", zoop$scientific_name)
zoop$scientific_name <- gsub("Oikopleura labradoriensis", "Oikopleura (Vexillaria) labradoriensis", zoop$scientific_name)
zoop$scientific_name <- gsub("^Copepod$", "Copepoda", zoop$scientific_name)
zoop$scientific_name <- gsub("Mesocalanus tenucornis", "Mesocalanus tenuicornis", zoop$scientific_name)
zoop$scientific_name <- gsub("Oikopleura dioica", "Oikopleura (Vexillaria) dioica", zoop$scientific_name)
zoop$scientific_name <- gsub("Ophuroidea", "Ophiuroidea", zoop$scientific_name)
zoop$scientific_name <- gsub("Scaphocalanus brevicaudatus", "Scaphocalanus brevicornis", zoop$scientific_name) 
zoop$scientific_name <- gsub("Siphonophore", "Siphonophorae", zoop$scientific_name)
zoop$scientific_name <- gsub("Polychaete", "Polychaeta", zoop$scientific_name)
# zoop$scientific_name <- gsub("Trochophore", " ", zoop$scientific_name)
zoop$scientific_name <- gsub("Fish", "Pisces", zoop$scientific_name)
zoop$scientific_name <- gsub("Muggiae atlantica", "Muggiaea atlantica", zoop$scientific_name)
zoop$scientific_name <- gsub("^Gastropod$", "Gastropoda", zoop$scientific_name)
# zoop$scientific_name <- gsub("Triconia ivlevi", " " , zoop$scientific_name) #TODO: What taxa is this?
zoop$scientific_name <- gsub("Squid", "Teuthida", zoop$scientific_name)
zoop$scientific_name <- gsub("Epicarid isopod", "Epicaridea", zoop$scientific_name)
zoop$scientific_name <- gsub("Tessarabrachion occulatum", "Tessarabrachion oculatum", zoop$scientific_name)
zoop$scientific_name <- gsub("Nematocelis difficilis", "Nematoscelis difficilis", zoop$scientific_name)
zoop$scientific_name <- gsub("Tuscaretta globulosa", "Tuscaretta globosa", zoop$scientific_name)
zoop$scientific_name <- gsub("Bivalve", "Bivalvia", zoop$scientific_name)
zoop$scientific_name <- gsub("Symbolophorous californiensis", "Symbolophorus californiensis", zoop$scientific_name)
zoop$scientific_name <- gsub("Euphausia pacficia", "Euphausia pacifica", zoop$scientific_name)
zoop$scientific_name <- gsub("Thysanoessa lonipes", "Thysanoessa longipes", zoop$scientific_name)
zoop$scientific_name <- gsub("Primno pacifica", "Primnoa pacifica", zoop$scientific_name)
zoop$scientific_name <- gsub("Aglama elegans", "Agalma elegans", zoop$scientific_name)
zoop$scientific_name <- gsub("Ctenophore", "Ctenophora", zoop$scientific_name)
zoop$scientific_name <- gsub("Rhynchonereella angellini", "Rhynchonereella angelini", zoop$scientific_name)
zoop$scientific_name <- gsub("Euchirella curticaudata", "Euchirella curticauda", zoop$scientific_name)
zoop$scientific_name <- gsub("Cununidae", "Cuninidae", zoop$scientific_name)
zoop$scientific_name <- gsub("Psuedosagitta scrippsae", "Pseudosagitta scrippsae", zoop$scientific_name)
zoop$scientific_name <- gsub("Nematode", "Nematoda", zoop$scientific_name)
zoop$scientific_name <- gsub("Stenobrachius leucropsarus", "Stenobrachius leucopsarus", zoop$scientific_name)
zoop$scientific_name <- gsub("Calanoid A", "Calanoida", zoop$scientific_name) #TODO: Confirm

sci_names <- unique(zoop$scientific_name) %>% as.data.frame()
colnames(sci_names)[1] <- "scientificname"
sci_names_1 <- sci_names[1:100,]
sci_names_2 <- sci_names[101:200,]
sci_names_3 <- sci_names[201:315,]

# Manual check for multiple AphiaIDs associated to same taxa:
worms_id_1 <- worrms::wm_records_names(sci_names_1, marine_only = T) %>% dplyr::bind_rows()
worms_id_2 <- worrms::wm_records_names(sci_names_2, marine_only = T) %>% dplyr::bind_rows()
worms_id_3 <- worrms::wm_records_names(sci_names_3, marine_only = T) %>% dplyr::bind_rows()
worms_id <- bind_rows(worms_id_1, worms_id_2, worms_id_3) %>%
  rename(scientific_name = scientificname) %>%
  select(scientific_name, AphiaID, 
         scientific_name_id = lsid,
         taxonomic_rank = rank) %>%
  distinct()

duplicates <- worms_id %>% group_by(scientific_name) %>% filter(n() > 1)

worms_id <- worms_id %>% 
  filter(!AphiaID %in% c("426434", "719191", "605966", "138835", "503291", "163921", "835292", "410743", "106331", 
                         "1434994")) %>%
  select(-AphiaID)

# confirmation that there's no duplicate spelled names:
sci_names <- zoop |> count(scientific_name)

zoop <- left_join(zoop, worms_id, by = "scientific_name")

dups_zoop <- zoop %>% group_by(net_id) %>% filter(n() > 1)

# Remove empty columns and replace NA by blank cells:
zoop <- zoop %>% mutate(across(where(is.character),~na_if(trimws(.),""))) %>%
   remove_empty("cols")

zoop <- sapply(zoop, as.character)
zoop[is.na(zoop)] <- ""
zoop <- as_tibble(zoop)

# Round abundance_m3 to 3 decimal places:
zoop$abundance_m3 <- as.numeric(zoop$abundance_m3)
zoop$abundance_m3 <- round(zoop$abundance_m3, 3)

# Consistency:
zoop$preservation_method <- tolower(zoop$preservation_method)
zoop$lifestage <- gsub("Adult", "adult", zoop$lifestage)

# Add "mm" to sf_proc because otherwise it's automatically read in as a date in Excel.
zoop$sf_proc <- ifelse(zoop$sf_proc != "", paste0(zoop$sf_proc, "mm"), zoop$sf_proc)

zoop_col_order <- c("station_event_id", "net_number", "net_id", "specimen_id", "verbatim_identification", 
                   "scientific_name", "scientific_name_id", "lifestage", "sex", "size_range", "taxonomic_rank",
                   "prop_total_sample", "sf_proc", "prop_sf_proc", "catch_count", "count_method",
                   "flowmeter_volume_filtered_m3", "depth_volume_filtered_m3", "abundance_m3", "preservation_method",
                   "comments")
zoop <- zoop[, zoop_col_order]

# Save Bongo Specimen data:
write_csv(zoop, here("output_datasets", "IYS_Bongo_specimen.csv"))

```

Next, integrate the CTD data (please note, we do not have CTD/Rosette data from the NW Explorer):

# CTD

```{r 2022 TINRO CTD}
TINRO_CTD <- read_excel(here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), sheet = "7. CTD INFO") |> 
    select(-c(sea_water_conductivity, sea_water_EC25, sea_water_turbidity,
         sea_water_chl_fluorescence, sea_water_chl_concentration,
         sea_water_dissolvedO2, sea_water_dissolvedO2_sat,
         sea_water_pH, sea_water_BOD5, Comments)) |> 
  rename(station_event_id = Station_Event_ID,
         instrument_type = Instrument_Type,
         instrument_model = Instrument_Model,
         sampling_depth_dbar = Sampling_Depth_Dbar,
         sea_water_temperature_degC = sea_water_temperature,
         sea_water_salinity_PSU = sea_water_salinity,
         `sea_water_density_kg/m3` = sea_water_density,
         ) |> 
  left_join(select(filter(TINRO_event, event_type == "CTD"), station_event_id, latitude_start_decdeg), by = "station_event_id") |> 
  mutate(sampling_depth_meters = swDepth(sampling_depth_dbar, latitude = latitude_start_decdeg)) |> 
  select(-latitude_start_decdeg)
```

```{r 2019 Kaganovsky CTD}
 
ctd_2019_data <- IYS_2019_CTD |> 
   select(station_event_ID, instrument_type:`sea_water_BOD5_mL/L`, latitude_start_decdeg) %>%
  rename(station_event_id = station_event_ID) |>
  mutate(sampling_depth_dbar = swPressure(sampling_depth_meters, latitude_start_decdeg)) |> 
  select(-latitude_start_decdeg)

```

```{r 2020 CTD}
ctd_2020 <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2020-CTD/master/standardized_data/2020_ctd.csv") |> 
  select(-cast) %>%
  rename(station_event_id = station_event_ID,
         `sea_water_concentration_of_oxygen_mL/L` = `sea_water_oxygen_mL/L`)
```


```{r 2022 Shimada CTD}

# There are replicate "channels" for some measurements. I understand these are replicate sensors. In theses cases I've defaulted to using channel 1 in all cases
shimada_CTD <- read_excel(here("input_datasets", "2022", "IYS2022_Shimada_Data.xlsx"), sheet = "7. CTD INFO") |> 
  select(station_event_id = Station_Event_ID, instrument_type = Instrument_Type, instrument_model = Instrument_Model, sampling_depth_dbar = Sampling_Depth_Dbar, sea_water_temperature_degC = sea_water_temperature_ch1, sea_water_salinity_PSU = sea_water_salinity_ch1, photosynthetic_active_radiation, sea_water_turbidity_NTU = sea_water_turbidity, sea_water_sigmaT = Sea_water_sigma_t_ch1, `sea_water_oxygen_concentration_umol/kg` = seawater_oxygen_concentration_ch1, sea_water_oxygen_saturation = seawater_oxygen_saturation_ch1) |> 
  dplyr::left_join(select(Shimada_event, station_event_id, latitude_start_decdeg)) |> 
  mutate(sampling_depth_meters = swDepth(sampling_depth_dbar, latitude = latitude_start_decdeg)) |> 
  select(-latitude_start_decdeg)


```

```{r 2022 Franklin CTD}
franklin_CTD <- read_excel(here("input_datasets", "2022", "IYS2022_Franklin_Data.xlsx"), sheet = "6. CTD INFO") |> 
  select(station_event_id = station_event_ID, instrument_type, instrument_model, DFO_Station_Event_ID = UNIQUE_EVENT, bottom_depth_meters, sampling_depth_meters, sampling_depth_dbar = Pressure_decibar, sea_water_temperature_degC = sea_water_temperature, sea_water_salinity_PSU = sea_water_salinity, `sea_water_conductivity_mS/cm` = sea_water_conductivity, `sea_water_concentration_of_oxygen_mL/L` = `Oxygen:Dissolved:SBE_mL/L`, sea_water_pH) |> 
  mutate(`sea_water_conductivity_mS/cm` = `sea_water_conductivity_mS/cm` * 10) # convert units

```


```{r Overall CTD}

janitor::compare_df_cols(TINRO_CTD, ctd_2019_data, ctd_2020, shimada_CTD, franklin_CTD)

IYS_CTD <- bind_rows(TINRO_CTD, ctd_2019_data, ctd_2020, shimada_CTD, franklin_CTD) |> 
  ungroup()

# QC value ranges for unit issues
ranges <- IYS_CTD |> 
  left_join(select(IYS_events, station_event_id, vessel_name_abbr)) |> 
  group_by(vessel_name_abbr) |> 
  summarise_all(range, na.rm = TRUE)

IYS_CTD <- IYS_CTD |> 
  select(station_event_id, instrument_type, instrument_model, 
         sampling_depth_meters, sampling_depth_dbar, sea_water_temperature_degC,
         sea_water_salinity_PSU)

ranges2 <- IYS_CTD |> 
  left_join(select(IYS_events, station_event_id, vessel_name_abbr)) |> 
  group_by(vessel_name_abbr) |> 
  summarise_all(range, na.rm = TRUE)

IYS_CTD <- right_join(IYS_events, IYS_CTD, by = "station_event_id") |> 
  remove_empty(which = "cols")

rename(IYS_CTD, original_event_id = alternative_event_id)

# Priority TODO:
#TODO: Figure out sigmaT for Franklin
#TODO: Ensure Sigma T is comparable across vessels
#TODO Figure out conductivity for TINRO and Shimada to complete the set

#secondary todos:
#TODO convert micromols/kg to mL/L for shimada oxygen concentration data?
#TODO Figure out density in kg/m3 for Shimada and Franklin
#TODO: Figure out whether oxygen measurements can be unit converted and combined
#

# QC CTD relations and keys
ctd_no_keys <- dm(filter(IYS_events, event_type %in% c("CTD", "CTD_Rosette")), IYS_CTD)

ctd_pk <- ctd_no_keys |> 
  dm_add_pk('filter(IYS_events, event_type %in% c("CTD", "CTD_Rosette"))', station_event_id)

ctd_pk |> dm_examine_constraints() 

ctd_dm <- ctd_pk |> 
  dm_add_fk(IYS_CTD, station_event_id, `filter(IYS_events, event_type %in% c("CTD", "CTD_Rosette"))`)

ctd_issues <- ctd_dm |>  dm_examine_constraints()s

write_csv(IYS_CTD, here("output_datasets", "IYS_CTD.csv"))

```

# Biogeochemistry Data

Include Biogeochemistry data

```{r}
#TODO combine rosette and CTD event IDs where possible
#TODO create 'bottle file' from rosette and CTD data (probably just add ctd data to rosette table at appropriate depths)
#TODO add 2022 Nutrient and oxygen data

TINRO_bottles <- read_excel(here("input_datasets", "2022", "IYS2022_TINRO_Data.xlsx"), 
                          sheet = "8. ROSETTE INFO")


```

# QC

```{r QC relations}
library(tidyverse)
library(dm)
library(here)
# read in output files
IYS_trawl_catch <- read_csv(here("output_datasets", "IYS_trawl_catch.csv"))

IYS_events <- read_csv(here("output_datasets", "IYS_events.csv"))

IYS_trawl_specimen <- read_csv(here("output_datasets", "IYS_trawl_specimen.csv"))

IYS_CTD <- read_csv(here("output_datasets", "IYS_CTD.csv"))

IYS_Bongo_specimen <- read_csv(here("output_datasets", "IYS_Bongo_specimen.csv"))

dm_no_keys <- dm(IYS_trawl_catch, IYS_events, IYS_trawl_specimen, IYS_CTD, IYS_Bongo_specimen)

# add primary keys
only_pk <- dm_no_keys %>% 
  dm_add_pk(IYS_trawl_catch, catch_id) %>% 
  dm_add_pk(IYS_events, station_event_id) %>% 
  dm_add_pk(IYS_trawl_specimen, specimen_id) |> 
  dm_add_pk(IYS_Bongo_specimen, specimen_id)
  
only_pk %>% dm_examine_constraints() # checks for duplicates in PK

# add foreign keys
dm <- only_pk %>% 
  dm_add_fk(IYS_CTD, station_event_id, IYS_events) %>% 
  dm_add_fk(IYS_trawl_specimen, catch_id, IYS_trawl_catch) %>% 
  dm_add_fk(IYS_trawl_catch, station_event_id, IYS_events) |> 
  dm_add_fk(IYS_Bongo_specimen, station_event_id, IYS_events)


dm %>% dm_examine_constraints() # checks that foreign keys all have a matching primary key in  the parent table
nw_issues <- dplyr::anti_join(IYS_trawl_specimen, IYS_trawl_catch, by = "catch_id")

# manually  export the drawing from the viewer pane to figs to update the data model image
dm_draw(dm)

events_str <- summary(IYS_events)


```

Combine all data frames into a single .xlsx workbook:

```{r final_join}
data_dictionary <- read_excel(here("input_datasets", "IYS_IDC_v4_DataDictionary.xlsx"))

# All IYS Expeditions:
out <- list("Data_Dictionary" = data_dictionary, "Sampling_Events" = IYS_events, 
            "Trawl_Catch_Data" = IYS_trawl_all, "Trawl_Specimen_Data" = IYS_trawl_specimen,
            "Bongo_Specimen_Data" = zoop, "CTD_Data" = IYS_CTD)

writexl::write_xlsx(out, here("Draft_V4.xlsx"))

#TODO: Once finalized, run the following code:
# writexl::write_xlsx(out, here("IYS_Integrated_Data_Collection_V4.xlsx"))
```

Create polygon coordinates for all events

```{r polygon coords}

polygon_coords <- function(df) {
  df <- df %>% tidyr::drop_na(lat, lon) %>% 
    dplyr::mutate(lon = dplyr::if_else(lon < 0, 360 + lon, lon))
  ch <- chull(df)
  coords <- df[c(ch, ch[1]), ]
  coords <- paste(coords$lat, coords$lon, sep = ",", collapse = " ")
  coords
}

df <- IYS2022_trawl_event %>% 
  select(lat = Latitude_Start_DecDeg, lon = Longitude_Start_DecDeg) %>% 
  filter(lat != 0 | lon != 0)

#copy output from console into metadata intake form polygon coordinates  
polygon_coords(df)

max(IYS2022_trawl_event$Maximum_Sampling_Depth_Meters)

```

```{r Stations list}
# This can be re-written later. I produced this stations plot list for Tetjana Ross
stations <- IYS2022_trawl_event |> 
  filter(event_type %in% c("CanTrawl", "Trawl")) |> 
  distinct(vessel_name_abbr, year, month, day, latitude_start_decdeg, longitude_start_decdeg) |> 
  rename(Lat = latitude_start_decdeg,
         Long = longitude_start_decdeg,
         vessel = vessel_name_abbr)

Franklin_stations <- Franklin_event |> 
  filter(Event_Type == "Trawl") |> 
  mutate(year = year(Time_Start_UTC),
         month = month(Time_Start_UTC),
         day = day(Time_Start_UTC)) |> 
  select(vessel = Vessel_Name_Abbr, year, month, day,
         Lat = Latitude_Start_DecDeg,
         Long = Longitude_Start_DecDeg)
  

stations_2019 <- GoA2019_event |> 
  mutate(year = year(EVENT_DATE),
         month = month(EVENT_DATE),
         day = day(EVENT_DATE)) |> 
  select(year, month, day, Lat = START_LATITUDE_DD, Long = longitude) |> 
  distinct()|> 
  mutate(vessel = "Kaganovksy")

stations_2020 <- GoA2020_event |> 
  mutate(year = year(EVENT_DATE),
         month = month(EVENT_DATE),
         day = day(EVENT_DATE)) |> 
  select(year, month, day, Lat = START_LAT_DECDEGREE, Long = START_LONG_DECDEGREE) |> 
  distinct() |> 
  mutate(vessel = "Pacific Legacy")


stations <- bind_rows(stations, Franklin_stations)

write_csv(stations, "stations.csv")
```

```{r join CTD data}

kag_ctd <- dplyr::right_join(IYS_events, IYS_CTD, by = c("station_event_id")) |> 
  filter(vessel_name_abbr == "Kaganovsky") |> 
  select(vessel_name_abbr, station, 
         sampling_depth_meters:sea_water_salinity_PSU)

kag_trawls <- IYS_events |> 
  filter (vessel_name_abbr == "Kaganovsky")

kag_ctd_trawls <- dplyr::right_join(kag_trawls, kag_ctd, by = "station")

anti_join(kag_trawls, kag_ctd, by = "station")

# Pacific Legacy 

leg_ctd <- dplyr::right_join(IYS_events, IYS_CTD, by = "station_event_id") |> 
  filter(vessel_name_abbr == "Legacy") |> 
  select(vessel_name_abbr, station, sampling_depth_meters:sea_water_salinity_PSU)

leg_trawls <- IYS_events |> 
  filter (vessel_name_abbr == "Legacy")

leg_ctd_trawls <- dplyr::right_join(leg_trawls, leg_ctd, by = "station")


anti_join(leg_trawls, leg_ctd, by = "station")

ctd_qc <- function(vessel){
  dplyr::right_join(IYS_events, IYS_CTD, by = "station_event_id") |> 
  filter(vessel_name_abbr == vessel) |> 
  select(vessel_name_abbr, station, sampling_depth_meters:sea_water_salinity_PSU)

leg_trawls <- IYS_events |> 
  filter (vessel_name_abbr == "Legacy")

leg_ctd_trawls <- dplyr::right_join(leg_trawls, leg_ctd, by = "station")
}
```
