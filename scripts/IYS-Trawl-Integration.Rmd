---
title: "IYS-Trawl-Integration"
author: "Tim van der Stap"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(lubridate)
library(chron)
library(janitor)
library(oce) # for computing depth from pressure and latitude
library(dm)
library(DiagrammeR)
knitr::opts_chunk$set(echo = TRUE)
```

For date integration, first download the processed data. For the 2022 data, this will be included in the IYS-data-template. From public repositories, we can download straight from the repository:  

```{r download IYS data template files}
download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("input_datasets",  "IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-TINRO-Data-Template/blob/main/IYS2022_TINRO.xlsx?raw=true", here::here("input_datasets", "IYS2022_TINRO_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/IYS2022_Shimada_Data_template.xlsx?raw=true", here::here("input_datasets", "IYS2022_Shimada_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-Franklin-Data-Template/blob/main/IYS_2022_FRANKLIN.xlsx?raw=true", here::here("input_datasets", "IYS2022_Franklin_Data.xlsx"), quiet = TRUE, mode = "wb")

# Remove comment from following lines of code once 2019 and 2020 trawl data is in a public repository:
download.file(" ", here::here("input_datasets", "GoA2019_Fish_Trawl_catch.xlsx"), quiet = TRUE, mode = "wb")
download.file(" ", here::here("input_datasets", "GoA2019_Fish_Specimen.xlsx"), quiet = TRUE, mode = "wb")
download.file(" ", here::here("input_datasets", "GoA2020_Fish_Trawl_catch.xlsx"), quiet = TRUE, mode = "wb")
download.file(" ", here::here("input_datasets", "GoA2020_Fish_Specimen.xlsx"), quiet = TRUE, mode = "wb")

```

# Trawl Data

## Event Data 

Now that we have the latest versions of the trawl data downloaded, we can read them in:

```{r event data}

NW_event <- read_excel(here("input_datasets", "IYS2022_NW_Data.xlsx"), 
                       sheet = "Sampling_Event_Info") %>%
  filter(Event_Type == "CanTrawl") |> 
  mutate(Event_Type = "Trawl")

TINRO_event <- read_excel(here("input_datasets", "IYS2022_TINRO_Data.xlsx"), 
                          sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type %in% c("Trawl", "CTD"))

Shimada_event <- read_excel(here("input_datasets", "IYS2022_Shimada_Data.xlsx"),
                            sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type %in% c("Trawl", "CTD"))

Franklin_event <- read_excel(here("input_datasets", "IYS2022_Franklin_Data.xlsx"),
                             sheet = "3. SAMPLING EVENT INFO") |> 
  filter(Event_Type %in% c("Trawl", "CTD_Rosette"))

#TODO Update 2019 event and catch data to read directly from public git repo
# Need to download this file manually from 2019 Trawl git repo
GoA2019_event <- read_excel(here("input_datasets",
                                 "2019_GoA_Fish_Trawl_catchdata.xlsx"),
                            sheet = "BRIDGE_LOG_FINAL") %>% filter(EVENT_TYPE %in% c("Trawl", "Can EEZ")) 

#TODO Update 2020 event and catch data to read directly from public git repo
# Need to download this file manually from 2020 Trawl git repo
GoA2020_event <- read_excel(here("input_datasets",
                                 "JuvSalmon_2020-01_Catch_v2021.1C_FINAL SUBMIT_jan18_2021 (2).xlsx"), 
                            sheet = "BRIDGE_LOG_FINAL")

# Raw Spirit event data 
#TODO: Replace the planned stations file below with actual stations conducted once data are received.
raw_spirit_event <- read_csv(here("input_datasets", "planned_raw_spirit_stations.csv")) |> 
  rename(latitude_start_decdeg = lat, longitude_start_decdeg = lon) |> 
  mutate(vessel_name_abbr = "Raw_Spirit",
         event_type = "Gillnet",
         year = 2022,
         comments = "This Raw Spirit event data only includes planned station coordinates") |> 
  select(vessel_name_abbr, event_type, year, latitude_start_decdeg, longitude_start_decdeg)
```

Compare event tables from the various vessel sampling events:

```{r event comparison}
# Check for differences in column header names and class between those data frames:
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event, Franklin_event, raw_spirit_event)
```

Looks like we have to do a little bit of cleaning before we join the data frames!

```{r Shimada event cleaning}
Shimada_event <- Shimada_event %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S"),
         Time_Zone_Code = "UTC",
         Station_Event_ID = ifelse(Event_Type == "CTD", paste0(Station_Event_ID, Maximum_Sampling_Depth_Meters), Station_Event_ID)) %>%
  dplyr::rename(Bottom_Depth_Meters = `Bottom_Depth*_Meters`) |> 
  rename_with(tolower)

# Change station class to character:
Shimada_event$station <- as.character(Shimada_event$station)
```

For NW data:

```{r NW event cleaning}
NW_event <- NW_event %>%
  dplyr::rename(Maximum_Sampling_Depth_Meters = Maximum_Sampling_Depth,
                Minimum_Sampling_Depth_Meters = Minimum_Sampling_Depth,
                Cruise_name = Cruise_Name) %>% # remember: rename(new = old)
  mutate(Time_Zone_Code = "UTC")

# Change class where needed:
NW_event$Month <- as.numeric(NW_event$Month)
NW_event$Day <- as.numeric(NW_event$Day)
NW_event$Time_End <- as.POSIXct(NW_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")
NW_event$Time_Start <- as.POSIXct(NW_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

NW_event <- NW_event |> 
  rename_with(tolower)

# Remove Can from the station_event_id:
NW_event$station_event_id <- gsub("Can", "", NW_event$station_event_id)

# Change station class to character:
NW_event$station <- as.character(NW_event$station)

# TODO: Additionally, you'll notice that there are three duplicate Station_Event_IDs. Likely - though needs confirmation - all the catch and specimen data comes from the trawl events that were ~60 minutes in length. Therefore, events that lasted 15 minutes will likely have to be filtered out. 
# NW_event <- NW_event %>% filter(Sampling_Duration_Minutes != "15") # Confirm with Jim & Murphy!
```

And for TINRO data:

```{r TINRO event cleaning}
# Trawl data is collected in GMT+12:00. So we have to subtract 12 hours from the Time_Start and Time_End to get to UTC. Additionally, we have to make sure this is then accurately reflected in the sampling **day** as well!
hrs <- 12 * 60 * 60

TINRO_event$date <- as.Date(paste(TINRO_event$Year, TINRO_event$Month, TINRO_event$Day, sep = "-"))
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S")
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

TINRO_event <- TINRO_event %>%
  mutate(eventDate_start = paste(date, Time_Start))
TINRO_event <- TINRO_event %>%
  mutate(eventDate_start = as.POSIXlt(TINRO_event$eventDate_start))
TINRO_event$eventDate_start$hour = TINRO_event$eventDate_start$hour-12

TINRO_event$eventDate_start <- as.character(TINRO_event$eventDate_start)

TINRO_event$Year <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%Y"))
TINRO_event$Month <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%m"))
TINRO_event$Day <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%d"))

# Reformat time, and transform to UTC:
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S")
TINRO_event$Time_End <- TINRO_event$Time_End - hrs
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S") 

TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S")
TINRO_event$Time_Start <- TINRO_event$Time_Start - hrs
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")# Change class and time to UTC for integration

# Sampling duration minutes has to be reformatted.
TINRO_event$Sampling_Duration_Minutes <- 60 * 24 * as.numeric(chron::times(TINRO_event$Sampling_Duration_Minutes)) 
TINRO_event$Sampling_Duration_Minutes <- round(TINRO_event$Sampling_Duration_Minutes, digits = 0)

# Change Time_Zone_Code to state that the Time_Start and Time_End now reflects UTC:
TINRO_event$Time_Zone_Code <- "UTC"

# Change station class to character:
TINRO_event$Station <- as.character(TINRO_event$Station)

# Remove temporary columns:
TINRO_event <- TINRO_event %>% select(-c(date, eventDate_start)) |> 
  rename_with(tolower)
```

And for Franklin data:

```{r Franklin event cleaning}
Franklin_event$Month <- ifelse(Franklin_event$Month == "Feb", "2", "3") %>% as.numeric()

# Change Tow_distance from kilometers per hour to nautical miles:
Franklin_event$Tow_distance[Franklin_event$Tow_distance=="NA"] <- 0
Franklin_event$Tow_distance <- as.numeric(Franklin_event$Tow_distance)
Franklin_event <- Franklin_event %>%
  mutate(tow_distance_nautical_miles = Tow_distance / 1.852)

Franklin_event$tow_distance_nautical_miles <- round(Franklin_event$tow_distance_nautical_miles, digits = 4)

Franklin_event <- Franklin_event %>% mutate(Time_Start_UTC = gsub(".*T", "", Franklin_event$Time_Start_UTC)) 
Franklin_event <- Franklin_event %>% mutate(Time_End_UTC = gsub(".*T", "", Franklin_event$Time_End_UTC))
Franklin_event <- Franklin_event %>% mutate(Time_Start_UTC = gsub("Z","",Franklin_event$Time_Start_UTC)) 
Franklin_event <- Franklin_event %>% mutate(Time_End_UTC = gsub("Z", "", Franklin_event$Time_End_UTC))

Franklin_event$Time_End_UTC <- as.POSIXct(Franklin_event$Time_End_UTC, format = "%H:%M:%S")  %>% format("%H:%M:%S")
Franklin_event$Time_Start_UTC <- as.POSIXct(Franklin_event$Time_Start_UTC, format = "%H:%M:%S") %>% format("%H:%M:%S")

# Rename and select columns to integrate:
Franklin_event <- Franklin_event %>%  
  rename_with(tolower) %>%
  dplyr::rename(alternative_event_id = dfo_station_event_id,
                time_start = time_start_utc,
                time_end = time_end_utc,
                tow_speed_kilometers_per_hour = tow_speed,
                bottom_depth_meters = bottom_depth_start,
                wave_height_meters = wave_height,
                sampling_duration_minutes = sampling_duration)

Franklin_event <- Franklin_event %>%
  mutate(time_zone_code = "UTC",
         wind_direction_degrees = NA,
         wind_direction_kilometers_per_hour = NA,
         swell_height_meters = NA,
         weather_description = NA) %>%
  select(cruise_name, vessel_name_abbr, zone, station, event_type, station_event_id, alternative_event_id, year, month, day, time_start, time_end,
         sampling_duration_minutes, day_night, time_zone_code, minimum_sampling_depth_meters, maximum_sampling_depth_meters,
         tow_speed_kilometers_per_hour, latitude_start_decdeg, longitude_start_decdeg, latitude_end_decdeg, longitude_end_decdeg,
         bottom_depth_meters, tow_distance_nautical_miles, wave_height_meters, swell_height_meters, weather_description, comments)

# TODO: Rather than select columns to include, remove columns not used.

# TODO: Clean up the following code lines: 
Franklin_event$sampling_duration_minutes <- as.numeric(Franklin_event$sampling_duration_minutes)
Franklin_event$minimum_sampling_depth_meters <- as.numeric(Franklin_event$minimum_sampling_depth_meters)
Franklin_event$maximum_sampling_depth_meters <- as.numeric(Franklin_event$maximum_sampling_depth_meters)
Franklin_event$wave_height_meters <- as.numeric(Franklin_event$wave_height_meters)
```

Clean up the GoA2019 Trawl event data:

```{r GOA2019 event cleaning}
# Make sure the Event_type is consistently "trawl":
GoA2019_event$EVENT_TYPE <- "Trawl"

# Change deployment and retrieval time from hhmm to hh:mm
GoA2019_event$END_DEPLOYMENT_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$END_DEPLOYMENT_TIME), format = "%H%M"), 12, 16) 
GoA2019_event$BEGIN_RETRIEVAL_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$BEGIN_RETRIEVAL_TIME), format = "%H%M"), 12, 16)

# Change the date/time to UTC: 
GoA2019_event <- GoA2019_event %>%
  mutate(eventDate_start = as.POSIXct(paste(EVENT_DATE_START, END_DEPLOYMENT_TIME)),
         eventDate_finish = as.POSIXct(paste(EVENT_DATE_FINISH, BEGIN_RETRIEVAL_TIME)))

GoA2019_event$eventDate_start <- lubridate::ymd_hms(GoA2019_event$eventDate_start, tz = "Asia/Vladivostok")
GoA2019_event$eventDate_start <- lubridate::with_tz(GoA2019_event$eventDate_start, "UTC")
GoA2019_event$eventDate_finish <- lubridate::ymd_hms(GoA2019_event$eventDate_finish, tz = "Asia/Vladivostok")
GoA2019_event$eventDate_finish <- lubridate::with_tz(GoA2019_event$eventDate_finish, "UTC")

# Extract time from the created eventDate_start and eventDate_finish:
GoA2019_event <- GoA2019_event %>% mutate(Time_Start = format(eventDate_start, "%H:%M:%S"),
                                          Time_End = format(eventDate_finish, "%H:%M:%S"))

GoA2019_event <- GoA2019_event %>%
  mutate(Cruise_name = "IYS2019",
         Vessel_Name_Abbr = "Kaganovsky",
         Zone = NA,
         Time_Zone_Code = "UTC",
         Minimum_Sampling_Depth_Meters = 0) %>%
  dplyr::rename(Station = TOW_NUMBER,
                Event_Type = EVENT_TYPE,
                Sampling_Duration_Minutes = TOW_DURATION,
                Day_Night = `Day /Night`,
                Maximum_Sampling_Depth_Meters = MOUTH_OPENING_HEIGHT,
                Latitude_Start_DecDeg = START_LATITUDE_DD,
                Longitude_Start_DecDeg = longitude,
                Latitude_End_DecDeg = END_LATITUDE_DD,
                Longitude_End_DecDeg = END_LONGITUDE_DD,
                Tow_distance_nautical_miles = DISTANCE_TRAVELLED,
                Tow_speed_kilometers_per_hour = SPEED,
                Wind_Direction_Degrees = WIND_DIRECTION,
                Wind_Speed_kilometers_per_hour = WIND_SPEED,
                Weather_description = WEATHER_COMMENTS, 
                Comments = `COMMENTS TRANSLATED TO ENGLISH`)

GoA2019_event$Year <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%Y"))
GoA2019_event$Month <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%m"))
GoA2019_event$Day <- as.numeric(format(as.Date(GoA2019_event$eventDate_start), "%d"))

# Change some classes:
GoA2019_event$Wind_Direction_Degrees <- as.numeric(GoA2019_event$Wind_Direction_Degrees)
GoA2019_event$Wind_Speed_kilometers_per_hour <- as.numeric(GoA2019_event$Wind_Speed_kilometers_per_hour)
GoA2019_event$Station <- as.character(GoA2019_event$Station)

GoA2019_event <- GoA2019_event %>%
  mutate(Sampling_Duration_Minutes = Sampling_Duration_Minutes * 60,
         station_event_id = paste(Cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Longitude_End_DecDeg = Longitude_End_DecDeg * -1,
         Bottom_Depth_Meters = rowMeans(GoA2019_event[ , c("BOTTOM_DEPTH_START_METERS", "BOTTOM_DEPTH_END_METERS")], na.rm = TRUE)) %>%
  select(Cruise_name, Vessel_Name_Abbr, Zone, Station, station_event_id, 
         Event_Type, Year, Month, Day, Time_Start, Time_End, Sampling_Duration_Minutes,
         Day_Night, Time_Zone_Code, Minimum_Sampling_Depth_Meters, 
         Maximum_Sampling_Depth_Meters, Tow_speed_kilometers_per_hour, Latitude_Start_DecDeg, 
         Longitude_Start_DecDeg, Latitude_End_DecDeg, Longitude_End_DecDeg, 
         Bottom_Depth_Meters, Tow_distance_nautical_miles,
         Wind_Direction_Degrees, Wind_Speed_kilometers_per_hour, Comments) |> 
  rename_with(tolower)

# Include CTD events
# Create event data for 2019 CTD
IYS_2019_CTD <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2019-CTD/main/standardized_data/IYS_2019_CTD.csv", guess_max = 60000)

ctd_2019_event <- IYS_2019_CTD |> 
   select(cruise_name:bottom_depth_meters) |> 
  distinct() |> 
  mutate(time_start = as.character(time_start)) |> 
  rename(station_event_id = station_event_ID)

ctd_2019_event$station <- as.character(ctd_2019_event$station)

janitor::compare_df_cols(GoA2019_event, ctd_2019_event)

GoA2019_event <- bind_rows(GoA2019_event, ctd_2019_event)
#TODO: confirm station number for trawls and ctd casts match
```

```{r GOA2020 event cleaning}
GoA2020_event <- GoA2020_event %>%
  mutate(Cruise_name = "IYS2020",
         Vessel_Name_Abbr = "Legacy",
         Zone = NA,
         Time_Zone_Code = "UTC",
         Minimum_Sampling_Depth_Meters = 0,
         Event_Type = "Trawl")

# Change the date/time to UTC: 
GoA2020_event$TIME_FISHING_START <- format(GoA2020_event$TIME_FISHING_START, "%H:%M:%S")
GoA2020_event$TIME_NET_RETREIVAL_START <- format(GoA2020_event$TIME_NET_RETREIVAL_START, "%H:%M:%S")

GoA2020_event <- GoA2020_event %>%
  mutate(eventDate_start = as.POSIXct(paste(EVENT_DATE, TIME_FISHING_START)),
         eventDate_finish = as.POSIXct(paste(EVENT_DATE, TIME_NET_RETREIVAL_START)))

GoA2020_event$eventDate_start <- lubridate::ymd_hms(GoA2020_event$eventDate_start, tz = "America/Los_Angeles") 
#TODO: Confirm: March 12, 2020 is PST (according to metadata), which is GMT-7. Confirm that time changes are accurate with tz = "America/Los_Angeles".
GoA2020_event$eventDate_start <- lubridate::with_tz(GoA2020_event$eventDate_start, "UTC")
GoA2020_event$eventDate_finish <- lubridate::ymd_hms(GoA2020_event$eventDate_finish, tz = "America/Los_Angeles")
GoA2020_event$eventDate_finish <- lubridate::with_tz(GoA2020_event$eventDate_finish, "UTC")

GoA2020_event <- GoA2020_event %>%
  dplyr::rename(Station = SET_NUMBER,
                Sampling_Duration_Minutes = `DURATION OF TOW (min)`,
                Day_Night = `DAY/NIGHT`,
                Latitude_Start_DecDeg = START_LAT_DECDEGREE,
                Longitude_Start_DecDeg = START_LONG_DECDEGREE,
                Latitude_End_DecDeg = END_LAT_DECDEGREE,
                Longitude_End_DecDeg = END_LONG_DECDEGREE,
                Tow_distance_nautical_miles = `DISTANCE OF FISHING OPERATION (nm)`,
                Wind_Direction_Degrees = `WIND DIRECTION (degrees)`,
                Wind_Speed_kilometers_per_hour = `WIND SPEED (knots)`, 
                Weather_description = `CLOUD/WEATHER`, 
                Comments = COMMENTS)

GoA2020_event$Year <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%Y"))
GoA2020_event$Month <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%m"))
GoA2020_event$Day <- as.numeric(format(as.Date(GoA2020_event$eventDate_start), "%d"))

# Change some classes:
GoA2020_event$Wind_Direction_Degrees <- as.numeric(GoA2020_event$Wind_Direction_Degrees)
GoA2020_event$Wind_Speed_kilometers_per_hour <- as.numeric(GoA2020_event$Wind_Speed_kilometers_per_hour)
GoA2020_event$Station <- as.character(GoA2020_event$Station)

# For Maximum_Sampling_Depth_Meters, Bottom_Depth_Meters and Tow_speed_kilometers_per_hour, these were measured at 15 minutes intervals. We'll take the average:
GoA2020_event <- GoA2020_event %>%
  mutate(Maximum_Sampling_Depth_Meters = rowMeans(GoA2020_event[ , c("NET OPENING DEPTH (metres) - 15 min", "NET OPENING DEPTH (metres) - 30 min",
                                                                     "NET OPENING DEPTH (metres) - 45 min", "NET OPENING DEPTH (metres) - END")],
                                                  na.rm = TRUE),
         Bottom_Depth_Meters = rowMeans(GoA2020_event[ , c("BOTTOM DEPTH (M) - 15 min", "BOTTOM DEPTH (M) - 30 min", 
                                                           "BOTTOM DEPTH (M) - 45 min", "BOTTOM DEPTH (M) - END")], na.rm = TRUE),
         Tow_speed_kilometers_per_hour = rowMeans(GoA2020_event[ , c("SPEED (Kn) - 15 min", "SPEED (Kn) - 30 min", "SPEED (Kn) - 45 min",
                                                                     "SPEED (Kn) - END")], na.rm = TRUE))

# To verify, manually check:
# check <-  GoA2020_event %>% select(c("NET OPENING DEPTH (metres) - 15 min", "NET OPENING DEPTH (metres) - 30 min", "NET OPENING DEPTH (metres) - 45 min", NET OPENING DEPTH (metres) - END", Maximum_Sampling_Depth_Meters"))

GoA2020_event <- GoA2020_event %>%
  mutate(station_event_id = paste(Cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-")) %>%
  select(Cruise_name, Vessel_Name_Abbr, Zone, Station, station_event_id, 
         Event_Type, Year, Month, Day,
         Time_Start = eventDate_start,
         Time_End = eventDate_finish, 
         Sampling_Duration_Minutes,
         Day_Night, Time_Zone_Code, Minimum_Sampling_Depth_Meters, Maximum_Sampling_Depth_Meters,
         Bottom_Depth_Meters, Tow_speed_kilometers_per_hour,
         Latitude_Start_DecDeg, Longitude_Start_DecDeg, Latitude_End_DecDeg, Longitude_End_DecDeg, 
         Tow_distance_nautical_miles, Wind_Direction_Degrees, Wind_Speed_kilometers_per_hour, Comments) 

GoA2020_event <- GoA2020_event %>% mutate(Time_Start = format(Time_Start, "%H:%M:%S"),
                                          Time_End = format(Time_End, "%H:%M:%S"))

# Change tow speed, currently in knots, to kilometers per hour for easy integration:
GoA2020_event$Tow_speed_kilometers_per_hour <-  GoA2020_event$Tow_speed_kilometers_per_hour * 1.852

GoA2020_event <- GoA2020_event %>% rename_with(tolower)

#TODO: Check with Chrys Neville whether the event_date for set_number 13 should be March 19 instead of March 18.
#TODO: Require trawl coordinates for set_number 20. 

# Import event data for 2020 CTD
ctd_2020_events <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2020-CTD/master/standardized_data/ctd_events.csv") |> 
  rename(station_event_id = station_event_ID) |> 
  mutate(time_start = as.character(time_start),
         time_end = as.character(time_end),
         station = as.character(station))

janitor::compare_df_cols(GoA2020_event, ctd_2020_events)

GoA2020_event <- bind_rows(GoA2020_event, ctd_2020_events)

```

Finally, join the data frames into a single sampling event data table: 

```{r All sampling events}
# Check for differences in column header names and class between those two data frames. 
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event, Franklin_event, GoA2019_event, GoA2020_event,
                         raw_spirit_event)

# Join the individual event data frames from all IYS High Seas Expeditions and make all column names :
IYS_events <- bind_rows(TINRO_event, NW_event, Shimada_event, Franklin_event, GoA2019_event, GoA2020_event, raw_spirit_event) |> 
  mutate(event_date = paste0(year,"-", 
                             ifelse(nchar(month) < 2, 
                                    paste0("0", month), month), "-",
                             ifelse(nchar(day) < 2,
                                    paste0("0", day),day), 
                             "T", time_start, "Z")) |> 
  select(cruise_name:station_event_id, alternative_event_id, event_date, year:comments) |> 
  mutate(day_night = tolower(day_night),
         date = as.Date(event_date, format = "%Y-%m-%d"),
         day_of_year = lubridate::yday(date)) %>%
  select(-date)

# Add dataset DOI by vessel:
IYS_events <- IYS_events %>%
  mutate(dataset_doi = case_when(
    vessel_name_abbr == "TINRO" & event_type == "Trawl" ~ "https://doi.org/10.21966/wevm-ww19",
    vessel_name_abbr == "TINRO" & event_type == "CTD" ~ "https://doi.org/10.21966/rfv4-e505",
    vessel_name_abbr == "Shimada" & event_type == "Trawl" ~ "https://doi.org/10.21966/nt8w-je90",
    vessel_name_abbr == "Franklin" & event_type == "Trawl" ~ "https://doi.org/10.21966/gmrz-ad56", 
    vessel_name_abbr == "NW" & event_type == "Trawl" ~ "https://doi.org/10.21966/shnm-s480",
    vessel_name_abbr == "Kaganovsky" & event_type == "Trawl" ~ "https://doi.org/10.21966/DPHZ-AS73",
    vessel_name_abbr == "Kaganovsky" & event_type == "CTD" ~ "https://doi.org/10.21966/66gj-7q46",
    vessel_name_abbr == "Legacy" & event_type == "Trawl" ~ "https://doi.org/10.21966/4J6T-GB64",
    vessel_name_abbr == "Legacy" & event_type == "CTD" ~ "https://doi.org/10.21966/nkc2-9m58"))

#QC event data
IYS_events |> group_by(vessel_name_abbr, event_type) |> 
  tally()

summary(IYS_events)

# Save event data:
write_csv(IYS_events, here("output_datasets", "IYS_events.csv"))
```

## Catch Data

Now let's join the overall catch data from these vessels into a specific data frame as well. 

```{r overall catch}
NW_catch <- read_excel(here("input_datasets", "IYS2022_NW_Data.xlsx"), sheet = "Catch_Info")
TINRO_catch <- read_excel(here("input_datasets", "IYS2022_TINRO_Data.xlsx"), sheet = "5. CATCH_FINAL INFO")
Shimada_catch <- read_excel(here("input_datasets", "IYS2022_Shimada_Data.xlsx"), sheet = "5. CATCH_FINAL INFO")
Franklin_catch <- read_excel(here("input_datasets", "IYS2022_Franklin_Data.xlsx"), sheet = "4. CATCH_FINAL INFO")

GoA2019_catch <- read_excel(here("input_datasets", "2019_GoA_Fish_Trawl_catchdata.xlsx"), sheet = "CATCH_FINAL")

GoA2020_catch <- read_excel(here("input_datasets", "2020_GoA_Fish_Trawl_data.xlsx"), sheet = "CATCH_FINAL")
```

Cleaning TINRO catch names:

```{r TINRO catch clean}
TINRO_catch <- TINRO_catch %>% rename_with(tolower) %>%
  mutate(worms_scientific_name = scientific_name)
```

Cleaning NW catch column names:

```{r NW catch clean}
NW_catch <- NW_catch %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Species_recorded = Species_Recorded,
                Catch_weight = Catch_Weight,
                Catch_count = Catch_Count) %>%
    rename_with(tolower) %>%
    mutate(worms_scientific_name = scientific_name) # create this column which we'll eventually 'clean up' based on correct WoRMS spelling. 

# Remove Can from station_event_id and catch_id
NW_catch$station_event_id <- gsub("Can", "", NW_catch$station_event_id)
NW_catch$catch_id <- gsub("Can", "", NW_catch$catch_id)
```

Cleaning Shimada catch column names to ensure integration:

```{r Shimada catch clean}
Shimada_catch <- Shimada_catch %>%
  dplyr::rename(dateIdentified = `dateIdentified (UTC)`) %>%
  rename_with(tolower) %>%
  mutate(worms_scientific_name = scientific_name)
```

Cleaning Franklin catch column names:

```{r Franklin catch clean}
Franklin_catch <- Franklin_catch %>% rename_with(tolower) %>% select(-speciesid) %>%
  dplyr::rename(alternative_catch_id = dfo_catch_id,
                alternative_event_id = dfo_station_event_id) %>%
  mutate(worms_scientific_name = scientific_name)
```

Cleaning GoA2019 catch column names:

```{r GOA2019 catch clean}
GoA2019_catch <- GoA2019_catch %>%
  mutate(cruise_name = "IYS2019",
         Vessel_Name_Abbr = "Kaganovsky",
         Zone = NA,
         Event_Type = "Trawl")
```

**IMPORTANT**: Please note, that the catch_count comes from a column `CATCH_COUNT (pieces)`, which includes Russian expansion for some species. In the original metadata this column is defined as _Total catch count. Note for most species this is total catch in cod end. However, for some small fish and jellies, this is the expanded count based on Russian expansion_. It does _not_ reflect the number in the cod_end (no expansion), or Number_net (expanded catch count-Russian). For these values, please refer back to the original catch data table from 2019. Please also note that the catch_weight reflects the mass in the codend (without expansion), which in the original metadata is defined as _Weight in cod-end - no expansion_.  

```{r catch_count, eval = FALSE}
GoA2019_catch <- GoA2019_catch %>%
  mutate(catch_count = ifelse(is.na(`Number_codend (no expansion)`), `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, 
                              ifelse(is.na(`CATCH_COUNT (pieces)(**includes Russian expansion for some species)`), `Number_codend (no expansion)`,
                              ifelse(`Number_codend (no expansion)` <= `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, `Number_codend (no expansion)`, NA))))

# Just check manually:
check_catches <- GoA2019_catch %>% select(`CATCH_COUNT (pieces)(**includes Russian expansion for some species)`, `Number_codend (no expansion)`, catch_count)

```

#TODO: If this is the correct way to go, include the above chunk below.

```{r GoA2019 catch clean cont., eval = FALSE}
GoA2019_catch <- GoA2019_catch %>%
  dplyr::rename(Station = `TOW_NUMBER (number)`,
                common_name = `common name`,
                Catch_weight = `Mass_codend (no expansion)`,
                species_code_russian = `SPECIES_CODE (russian))`,
                Catch_count = `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`,
                Lifestage = `age group ( for salmon 5= juv, 4 immature, 3 mature, 0 unknown)`,
                Comments = COMMENTS) %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Catch_ID = paste(Station_Event_ID, row_number(), sep = "-"),
         Species_recorded = NA,
         Scientific_Name = paste(genus, species, sep = " "), 
         worms_scientific_name = paste(genus, species, sep = " "), # create this column to change scientific names based on WoRMS Registry while retaining the original spelling.
         Taxonomic_rank = ifelse(grepl("sp.", GoA2019_catch$species), "genus", "species"),
         Catch_weight_units = "kilograms") %>%
  select(Station, Station_Event_ID, Catch_ID, Species_recorded, Scientific_Name, Taxonomic_rank, species_code_russian, Lifestage, 
         common_name, Catch_weight, Catch_weight_units, Catch_count, Comments) %>%
  rename_with(tolower)
```



```{r GoA2019 catch clean cont.} 
# Currently, lifestage is either 5, 4, 3 or 0, which is not very descriptive. As per comments in the column, these are changed:
GoA2019_catch <- GoA2019_catch %>%
  mutate(lifestage = case_when(
    lifestage == "5" ~ "juvenile",
    lifestage == "4" ~ "immature",
    lifestage == "3" ~ "mature",
    lifestage == "0" ~ "unknown"))

# Remove the sp., sp and gen. sp. 1 from the worms_scientific_name column, as the taxonomic rank is provided in a different column:
GoA2019_catch$worms_scientific_name <- gsub("\\b sp.\\b|\\b sp\\b|\\b gen. sp. 1\\b", "", GoA2019_catch$scientific_name) 

# Finally, in the specimen data there is mention of Periphylla periphylla caught, however after matching to the species_code_russian, this is included in the catch data as Chrysaora melonaster. Therefore, we change this in the GoA2019_catch data. 
#TODO: Perhaps better to omit if uncertain...?
GoA2019_catch <- GoA2019_catch %>% mutate(scientific_name = ifelse(station == "51" & scientific_name == "Chrysaora melonaster" & species_code_russian == "89190101",
                                          "Periphylla periphylla", scientific_name))
GoA2019_catch <- GoA2019_catch %>% mutate(species_code_russian = ifelse(station == "48" & species_code_russian == "8+G342:I3492920152", "82920152", species_code_russian))

# Remove excess columns:
GoA2019_catch <- GoA2019_catch %>% select(-station)

#TODO: Determine whether taxa names should be corrected to fit WoRMS database? I think _yes_ but include original Latin recording as verbatim_identification.
```

Cleaning GoA2020 catch column names:

```{r GOA2020 catch clean}
GoA2020_catch <- GoA2020_catch %>%
  mutate(cruise_name = "IYS2020",
         Vessel_Name_Abbr = "Legacy",
         Zone = NA,
         Event_Type = "Trawl") %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_Name_Abbr, SET_NUMBER, Event_Type, sep = "-"),
         Catch_ID = paste(Station_Event_ID, row_number(), sep = "-")) %>%
  dplyr::rename(common_name = `SPECIES (Description if needed)`,
                catch_weight = `CATCH_WEIGHT (KG)`,
                catch_count = CATCH_NUMBER,
                Scientific_name = SPECIES) %>%
  mutate(catch_weight_units = "kilograms",
         worms_scientific_name = Scientific_name,
         Species_recorded = NA,
         Taxonomic_rank = NA,
         Lifestage = NA) %>%
  select(Station_Event_ID, Catch_ID, Species_recorded, Scientific_name, worms_scientific_name, Taxonomic_rank, Lifestage, common_name, catch_weight,
         catch_weight_units, catch_count, Comments) %>%
  rename_with(tolower)

# TODO: Determine whether taxa names should be corrected to fit WoRMS Database, if so, taxonomic rank can be deduced. 
```

Compare column names between catch data frames: 

```{r All Catch Data}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_catch, TINRO_catch, Shimada_catch, Franklin_catch, GoA2019_catch, GoA2020_catch)

# Bind rows and save for catch from only 2022 and catch from all IYS High Seas Expeditions:

#TODO: Include GoA2019_catch and GoA2020_catch once confident
IYS_trawl_catch <- bind_rows(TINRO_catch, NW_catch, Shimada_catch, Franklin_catch, GoA2019_catch, GoA2020_catch)

IYS_trawl_catch$dateidentified <- as.character(IYS_trawl_catch$dateidentified)

#QC Catch data
# Confirm there are no duplicates in the Catch_ID:
IYS_trawl_catch$catch_id[duplicated(IYS_trawl_catch$catch_id)] # should print character(0)

sci_names <- IYS_trawl_catch |> count(scientific_name)
#TODO Fix scientific names that are spelled differently

# Check that all ranks are eithr upper or lower case
taxonomi_ranks <- IYS_trawl_catch |> count(taxonomic_rank)

IYS_trawl_catch$taxonomic_rank <- tolower(IYS_trawl_catch$taxonomic_rank)

IYS_trawl_catch |> count(lifestage)
IYS_trawl_catch$lifestage <- tolower(IYS_trawl_catch$lifestage)

# Join station_event_ids from event table to catch_ids, to see if there are any recorded sampling events that didn't end up catching anything:
trawl_event <- IYS_events %>% filter(event_type == "Trawl" & year == "2022") %>% select(station_event_id)
IYS_trawl_catch <- left_join(IYS_trawl_catch, trawl_event, by = "station_event_id") %>%
  mutate(comments = ifelse(station_event_id == "IYS2022-TINRO-3-6-Trawl", "Trawl was successful, but no species were caught.", comments),
         comments = ifelse(station_event_id == "IYS2022-Shimada-4-2-Trawl", "Codend wasn't fully closed so nothing was retained in codend.", comments))

# Remove " sp." and special characters (i.e. brackets) from scientific_name and adjust spelling: 
IYS_trawl_catch$worms_scientific_name <- gsub("\\b sp.\\b", "", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("[[:punct:]]", "", IYS_trawl_catch$worms_scientific_name)

# Verify there are no special characters and 'sp.' left:
sci_names <- IYS_trawl_catch |> count(worms_scientific_name)

# Match the unique recorded species to the WoRMS database. Check manually because sometimes multiple AphiaIDs are associated, which need to be removed.
IYS_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_catch$worms_scientific_name)) %>% bind_rows() %>% rename(worms_scientific_name = scientificname) %>%
  select(worms_scientific_name, AphiaID, lsid)

unid_species <- left_join(IYS_trawl_catch, IYS_scientificnames, by = "worms_scientific_name") %>% filter(is.na(AphiaID)) 
unid_species <- unique(unid_species$worms_scientific_name)

# We see that there are x species that don't have a match in the WoRMS Registry, change these names in the original dataframe (column: worms_scientific_name):
IYS_trawl_catch$worms_scientific_name <- gsub("Oncorhynchus tschawytscha", "Oncorhynchus tshawytscha", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Phacellophora camtchatica", "Phacellophora camtschatica", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Glyptocephalus zachiris", "Glyptocephalus zachirus", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Argropelecus sladeni", "Argyropelecus sladeni", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Scyphozoa class", "Scyphozoa", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("^Amphipod$", "Amphipoda", IYS_trawl_catch$worms_scientific_name) # Please note the ^ and $ to indicate start and 
IYS_trawl_catch$worms_scientific_name <- gsub("Onychoteuthis borealijaponicus", "Onychoteuthis borealijaponica", IYS_trawl_catch$worms_scientific_name)
IYS_trawl_catch$worms_scientific_name <- gsub("Unknown fish", "Pisces", IYS_trawl_catch$worms_scientific_name)

#TODO: Additionally, in the 2020 dataset there are observations like e.g. "Gooseneck barnacle" that are currently included under scientific_name. It's probably best to include these under 'species_recorded'

# Rematch the unique recorded species to the WoRMS registry to ensure all names have been changed appropriately. Check manually because sometimes multiple AphiaIDs are associated to a taxa or species, which need to be removed. 
IYS_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_catch$worms_scientific_name)) %>% bind_rows() %>% rename(worms_scientific_name = scientificname) %>%
  select(scientific_name, AphiaID, lsid) %>% filter(!AphiaID %in% c("1434994", "106331", "163921"))

IYS_trawl_catch <- left_join(IYS_trawl_catch, IYS_scientificnames, by = "worms_scientific_name") %>%
  rename(scientific_name_id = lsid) %>%
  select(-AphiaID)

# Confirm again that there's no duplicate spelled names:
sci_names <- IYS_trawl_catch |> count(scientific_name)

# Save catch data:
write_csv(IYS_trawl_catch, here("output_datasets", "IYS_trawl_catch.csv"))
```

## Specimen Data

Now let's join the overall specimen data from these vessels into a specific data frame as well. 

Note: Evgeny indicated it would be good to have GSI and age data in the specimen tables once they are available

```{r overall specimen}
NW_specimen <- read_excel(here("input_datasets", "IYS2022_NW_Data.xlsx"), sheet = "Specimen_Info")
TINRO_specimen <- read_excel(here("input_datasets", "IYS2022_TINRO_Data.xlsx"), sheet = "6. SPECIMEN INFO")
Shimada_specimen <- read_excel(here("input_datasets", "IYS2022_Shimada_Data.xlsx"), sheet = "6. SPECIMEN INFO")
Franklin_specimen <- read_excel(here("input_datasets", "IYS2022_Franklin_Data.xlsx"), sheet = "5. SPECIMEN INFO")

GoA2019_specimen <- read_excel(here("input_datasets", "2019_GoA_Fish_Specimen_data.xlsx"), sheet = "SPECIMEN_FINAL")
GoA2020_specimen <- read_excel(here("input_datasets", "2020_GoA_Fish_Specimen_data.xlsx"), sheet = "SPECIMEN_FINAL", guess_max = 5900)


GoA2019_specimen <- read_excel(here("input_datasets", "JuvSalmon_2019-01_Specimens_v21.01b_SUBMITTED_COPY.xlsx"), sheet = "SPECIMEN_FINAL")
# I think we should consider maybe using the working file for this dataset that I also used to standardize the data for OBIS.
GoA2020_specimen <- read_excel(here("input_datasets", "2020-01 Specimen file.v21.1c_FINAL SUBMIT_jan18_2021.xlsx"), 
                            sheet = "SPECIMEN_FINAL", guess_max = 5900)
# Similarly, I think we should consider maybe using the working file for this dataset that I also used to standardize the data for OBIS. 
# For both the 2019 and 2020 specimen data working files, we can include the pull in the latest version of the changelog and save it in this repo if needed?

#TODO: Integrate age data
#TODO: Integrate genetic stock ID data
#TODO: Integrate external marks data
```


Cleaning NW specimen column names:

```{r NW specimen clean}
NW_specimen <- NW_specimen %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Specimen_ID = `Specimen ID`,
                Specimen_Length = Length,
                Specimen_Weight = Weight) %>%
  rename_with(tolower) %>%
  mutate(worms_scientific_name = scientific_name) # Add this column in case we need to make changes to the spelling at a later stage. 

# Remove Can from the station_event_id, catch_id and specimen_id:
NW_specimen$station_event_id <- gsub("Can", "", NW_specimen$station_event_id)
NW_specimen$catch_id <- gsub("Can", "", NW_specimen$catch_id)
NW_specimen$specimen_id <- gsub("Can", "", NW_specimen$specimen_id)
```

Cleaning Franklin, TINRO, and Shimada specimen column names:

```{r TINRO, Shimada, Frankin}
TINRO_specimen <- TINRO_specimen %>% rename_with(tolower) %>%
  select(-c(fin_clip, gill:note)) %>%
  mutate(worms_scientific_name = scientific_name) # Add this column in case we need to make changes to the spelling at a later stage. 

Shimada_specimen <- Shimada_specimen %>% rename_with(tolower) %>%
  rename(alternative_specimen_id = `barcode number`) %>%
  mutate(worms_scientific_name = scientific_name)

Shimada_specimen$alternative_specimen_id <- as.character(Shimada_specimen$alternative_specimen_id)

Franklin_specimen <- Franklin_specimen %>% rename_with(tolower) %>%
  dplyr::rename(alternative_event_id = dfo_station_event_id,
                alternative_catch_id = dfo_catch_id,
                alternative_specimen_id = dfo_specimen_id,
                lifestage = ageclass) %>%
  select(-specimenid) %>%
  mutate(worms_scientific_name = scientific_name)

Franklin_specimen$specimen_length <- as.numeric(Franklin_specimen$specimen_length)
Franklin_specimen$specimen_weight <- as.numeric(Franklin_specimen$specimen_weight)
```

Clean the GOA2019 Trawl specimen data to integrate with 2022 data:

```{r GOA2019 specimen clean}
GoA2019_specimen <- GoA2019_specimen %>%
  mutate(cruise_name = "IYS2019",
         Vessel_name_abbr = "Kaganovsky", 
         Zone = NA,
         Event_Type = "Trawl",
         data_type = "specimen",
         Scientific_Name = paste(genus, species, sep = " "),
         worms_scientific_name = paste(genus, species, sep = " ")) %>% # Add this column in case we need to make changes to the spelling at a later stage. 
  dplyr::rename(Station = TOW_NUMBER,
                common_name = `common name`,
                species_code_russian = `SPECIES CODE (Russian)`) %>%
  select(Station, common_name, LENGTH, SEX_CODE, `WEIGHT - TOTAL`, cruise_name, Vessel_name_abbr, Zone, Scientific_Name, Event_Type,
         data_type, species_code_russian)

GoA2019_specimen$species_code_russian <- as.character(GoA2019_specimen$species_code_russian)

GoA2019_specimen <- GoA2019_specimen %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_name_abbr, Station, Event_Type, sep = "-"))

# We want to compare the catch and the specimen data tables by joining them by Station_Event_ID and Scientific_Name. Therefore, we have to ensure that the spelling of Scientific_Names at least matches between these data frames (regardless of whether it is accuratedly represented in WORMS)
specimen_unique <- unique(GoA2019_specimen$Scientific_Name)
catch_unique <- unique(GoA2019_catch$scientific_name)

setdiff(specimen_unique, catch_unique)

# You can notice that in the specimen data, species names' are often followed by Russian (e.g. полов.). We need to remove these as otherwise we can't properly connect the catch to the specimen data. 
GoA2019_specimen$Scientific_Name <- gsub("[()]", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" неполов.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" сегол.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" полов.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" мол.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub("\\b sp. 1\\b|\\b sp.\\b", "", GoA2019_specimen$Scientific_Name)

GoA2019_catch$scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", GoA2019_catch$scientific_name)

GoA2019_specimen <- GoA2019_specimen %>%
  rename_with(tolower)

#Some specimen data have a species_code that is not reflected in the catch_data. As a result, these do not get matched up properly. As such, for now, I'll make some changes to the species_code in the specimen_data so that these rows can get properly matched with the catch data. 
#TODO: Confirm with data provider (C. Neville) and consider making these changes in the specimen data file. 
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "5" & species_code_russian == "82920152", "82920102", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "12" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "13" & species_code_russian == "82920152", "82920102", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "29" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "30" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "32" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "35" & species_code_russian == "14350411", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "36" & species_code_russian %in% c("14350419", "14350411"), "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "44" & species_code_russian %in% c("14340419", "14350411"), "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "45" & species_code_russian == "14350419", "14350416", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(scientific_name = ifelse(station == "52" & species_code_russian == "80880402", "Calycopsis", scientific_name))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & species_code_russian == "82920102", "82920152", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & scientific_name == "Gonatus onyx", "82920257", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "54" & species_code_russian == "14350414", "14350417", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "59" & species_code_russian == "82920152", "13231901", species_code_russian))
GoA2019_specimen <- GoA2019_specimen %>% mutate(scientific_name = ifelse(station == "62" & species_code_russian == "13660101", "Lestidium ringens", scientific_name))
GoA2019_specimen <- GoA2019_specimen %>% mutate(species_code_russian = ifelse(station == "64" & species_code_russian == "82920102", "82920152", species_code_russian))

# Left join to the GoA2019_catch data table so that we can create the specimen_IDs
merge <- left_join(GoA2019_catch, GoA2019_specimen, by = c("station_event_id", "scientific_name", "species_code_russian"))
merge <- merge %>% group_by(catch_id) %>% 
  mutate(specimen_id = paste(catch_id, row_number(), sep = "-")) %>%
  ungroup()

GoA2019_specimen_tab <- merge %>% filter(data_type == "specimen") %>%
  dplyr::rename(specimen_length = length,
                specimen_weight = `weight - total`,
                sex = sex_code) %>%
  select(station_event_id, catch_id, specimen_id, species_recorded, scientific_name, lifestage, specimen_length,
         specimen_weight, sex) %>%
  mutate(length_units = "millimeters",
         weight_units = "grams") 

#TODO: Add length_type for species, as per conversation with CN. 
GoA2019_specimen_tab <- GoA2019_specimen_tab %>%
  mutate(length_type = case_when(
    .$scientific_name %in% c("Hormiphora cucumis", "Salpa sp.", "Ctenephores sp.", "Thysanoessa spinifera", "Aurelia labiata", "Chrysaora melonaster", "Calycopsis sp.", "Paralepididae gen. sp. 1", "Siphonophora sp.", "Microstomus pacificus", "Tarletonbeania crenularis", "Corolla calceola", "Squalus suckleyi", "Thalassenchelys coheni", "Sergestes similis", "Aptocyclus ventricosus", "Sebastes melanops", "Anotopterus nikparini", "Zaprora silenus", "Gasterosteus aculeatus", "Thetys vagina") ~ "Total length",
    .$scientific_name %in% c("Lestidium ringens", "Oncorhynchus gorbuscha", "Oncorhynchus kisutch", "Oncorhynchus keta", "Oncorhynchus nerka", "Oncorhynchus tschawytscha", "Icichthys lockingtoni") ~ "Fork length",
    .$scientific_name %in% c("Symbolophorus californiense", "Stenobrachius leucopsarus", "Diaphus theta", "Lipolagus ochotensis") ~ "Standard length",
    .$scientific_name %in% c("Phacellophora camtshchatica", "Aurelia limbata", "Periphylla periphylla") ~ "Bell diameter",
    .$scientific_name %in% c("Gonatus sp.", "Gonatidae sp.", "Boreoteuthis borealis", "Gonatus onyx", "Onychoteuthis borealijaponica", "Abraliopsis felis", "Japetella diaphana", "Moroteuthis robusta", "Belonella borealis", "Gonatus madokai", "Chiroteuthis calyx") ~ "Mantle length"))

```

Clean the GoA2020 Trawl specimen data to integrate with 2022 data:

```{r GOA2020 specimen clean}
GoA2020_specimen <- read_excel(here("input_datasets", "2020-01 Specimen file.v21.1c_FINAL SUBMIT_jan18_2021.xlsx"), 
                            sheet = "SPECIMEN_FINAL")

GoA2020_specimen <- GoA2020_specimen %>%
  mutate(cruise_name = "IYS2020",
         Vessel_name_abbr = "Legacy", 
         Zone = NA,
         Event_Type = "Trawl",
         data_type = "specimen") %>%
  mutate(station_event_id = paste(cruise_name, Vessel_name_abbr, SET_NUMBER, Event_Type, sep = "-")) %>%
  select(station_event_id, data_type, SET_NUMBER, SPECIES, SPECIES_DESCRIPTION, `LENGTH (FORK) - mm`, `LENGTH (STANDARD) - mm`, `LENGTH (TOTAL)`, 
         `LENGTH (MANTLE) - cm`, `WEIGHT - ROUND (g)`, SEX, `DEVELOPMENTAL STAGE`, COMMENTS) %>%
  dplyr::rename(scientific_name = SPECIES,
                lifestage = `DEVELOPMENTAL STAGE`)

# We want to compare the catch and the specimen data tables by joining them by Station_Event_ID and Scientific_Name. Therefore, we have to ensure that the spelling of Scientific_Names at least matches between these data frames (regardless of whether it is accuratedly represented in WORMS)
specimen_unique <- unique(GoA2020_specimen$scientific_name)
catch_unique <- unique(GoA2020_catch$scientific_name)

setdiff(specimen_unique, catch_unique)

# There are 7 taxa whose names have to be adjusted between the catch and specimen data to align them:
# Paralepididae, Oncorhynchus gorbusha, Pterotrachea sp., Phacellophoroa camtschatica, Dosidicus gigas?, Calycopsis, Unknown jelly
GoA2020_specimen$scientific_name <- gsub("Paralepididae", "Paralepidadae", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Oncorhynchus gorbusha", "Oncorhynchus gorbuscha", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Pterotrachea sp.", "Ptereotrachea sp.", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Phacellophoroa camtschatica", "Phacellophora camtschatica", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("\\?", "", GoA2020_specimen$scientific_name) # To remove the ? from Dosidicus gigas
GoA2020_specimen$scientific_name <- gsub("Calycopsis", "Calycopsis sp.", GoA2020_specimen$scientific_name)
GoA2020_specimen$scientific_name <- gsub("Unknown jelly", "jellyfish", GoA2020_specimen$scientific_name)

# Confirm no different in species names between catch data and specimen data:
setdiff(specimen_unique, catch_unique) # should be character(0)

# Left join to the GoA2019_catch data table so that we can create the specimen_IDs
merge <- left_join(GoA2020_catch, GoA2020_specimen, by = c("station_event_id", "scientific_name", "lifestage"))
merge <- merge %>% group_by(catch_id) %>% 
  mutate(specimen_id = paste(catch_id, row_number(), sep = "-")) %>%
  ungroup()

#TODO: Figure out how to standardize if 2 length measurements are provided:

GoA2020_specimen_tab <- merge %>% filter(data_type == "specimen") %>% select(-comments) %>%
  mutate(specimen_length = ifelse(
    !is.na(`LENGTH (FORK) - mm`), `LENGTH (FORK) - mm`, ifelse(
    !is.na(`LENGTH (STANDARD) - mm`), `LENGTH (STANDARD) - mm`, ifelse(
    !is.na(`LENGTH (TOTAL)`), `LENGTH (TOTAL)`, ifelse(
    !is.na(`LENGTH (MANTLE) - cm`), `LENGTH (MANTLE) - cm`, NA)))))  

# Check to see if it works:
manual_check <- GoA2020_specimen_tab %>% select(`LENGTH (FORK) - mm`, `LENGTH (STANDARD) - mm`, `LENGTH (TOTAL)`, `LENGTH (MANTLE) - cm`, specimen_length)

# Notice how sometimes multiple length measurements are given (i.e. both fork and standard). We have to account for this:

GoA2020_specimen_tab <- GoA2020_specimen_tab %>%
  mutate(specimen_length2 = ifelse(!is.na(`LENGTH (FORK) - mm`) & !is.na(`LENGTH (STANDARD) - mm`), `LENGTH (STANDARD) - mm`, NA)) %>%
  mutate(length_type = case_when(`LENGTH (FORK) - mm` > 0 ~ "Fork Length",
                                 `LENGTH (STANDARD) - mm` > 0 ~ "Standard Length",
                                 `LENGTH (TOTAL)` > 0 ~  "Total Length",
                                 `LENGTH (MANTLE) - cm` > 0 ~ "Bell Diameter"),
         length_type2 = case_when(`LENGTH (FORK) - mm` > 0 & `LENGTH (STANDARD) - mm` > 0 ~ "Standard Length"),
         length_units = case_when(`LENGTH (FORK) - mm` > 0 ~ "millimeters",
                                  `LENGTH (STANDARD) - mm` > 0 ~ "millimeters",
                                  `LENGTH (TOTAL)` > 0 ~ "millimeters",
                                  `LENGTH (MANTLE) - cm` > 0 ~ "centimeters"))

GoA2020_specimen_tab <- GoA2020_specimen_tab %>%
  dplyr::rename(specimen_weight = `WEIGHT - ROUND (g)`) %>%
  mutate(weight_units = "grams") %>%
  rename_with(tolower) %>%
  select(station_event_id, catch_id, specimen_id, species_recorded, scientific_name, taxonomic_rank, lifestage, common_name, 
         specimen_length, specimen_length2, length_type, length_units, length_type2, specimen_weight, weight_units, sex, comments)

# Change class for columns:
GoA2020_specimen_tab$specimen_length <- as.numeric(GoA2020_specimen_tab$specimen_length)
GoA2020_specimen_tab$specimen_length2 <- as.numeric(GoA2020_specimen_tab$specimen_length2)
GoA2020_specimen_tab$sex <- as.character(GoA2020_specimen_tab$sex)
```

Join the specimen data rows. 

```{r All specimen Data}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_specimen, TINRO_specimen, Shimada_specimen, Franklin_specimen, GoA2019_specimen_tab, GoA2020_specimen_tab)

# Bind rows and save: 
#TODO Include GoA2019_specimen_tab and GoA2020_specimen_tab when confident
IYS_trawl_specimen <- bind_rows(TINRO_specimen, NW_specimen, Shimada_specimen, Franklin_specimen)

# Change length_units 'Centimeters' to 'Millimeters' and change the length measurement accordingly:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(specimen_length = ifelse(length_units == "Centimeters", specimen_length * 10, specimen_length),
         length_units = "Millimeters")

# Make the lifestages all lowercase, so we don't have both Adult and adult:
IYS_trawl_specimen$lifestage <- tolower(IYS_trawl_specimen$lifestage)

# Change some of the sex to make integration easier:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(sex = ifelse(sex == "m", "Male", sex),
         sex = ifelse(sex == "f", "Female", sex),
         sex = ifelse(sex == "?", "Unknown", sex))

#TODO: Figure out what to do with "f?" and "N".

# Change specimen_weight to reflect grams, and ensure that weight_units = Grams:
IYS_trawl_specimen <- IYS_trawl_specimen %>%
  mutate(specimen_weight = ifelse(weight_units %in% c("Kilograms", "kilograms"), specimen_weight * 1000, specimen_weight),
         weight_units = "Grams")

#QC specimen data
#TODO: Get corrections for duplicate specimen IDs
# Confirm no duplicates in Specimen_ID:
IYS_trawl_specimen$specimen_id[duplicated(IYS_trawl_specimen$specimen_id)] # should print character(0)

specimen_names <- IYS_trawl_specimen |> 
  count(scientific_name)

# Duplicate scientific_name column to 'verbatim_identification', and use worrms to change the names in scientfic_name to fit the WoRMS registry.
IYS_trawl_specimen$verbatim_identification <- IYS_trawl_specimen$scientific_name

# Remove " sp." and special characters (i.e. brackets) from scientific_name and adjust spelling: 
IYS_trawl_specimen$scientific_name <- gsub("\\b sp.\\b", "", IYS_trawl_specimen$scientific_name)

# Match the unique recorded species to the WoRMS database. Check manually because sometimes multiple AphiaIDs are associated, which need to be removed.
IYS_spp_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_specimen$scientific_name)) %>% bind_rows() %>% rename(scientific_name = scientificname) %>%
  select(scientific_name, AphiaID, lsid)

unid_species <- left_join(IYS_trawl_specimen, IYS_spp_scientificnames, by = "scientific_name") %>% filter(is.na(AphiaID)) 
unid_species <- unique(unid_species$scientific_name)

# We see that in the overall catch data there are 9 (including 'NA') species that don't have a match in the WoRMS Registry, change these names in the original dataframe. Please note that Oncorhynchus tschawythscha does get an AphiaID, but WoRMS indicates that the spelling is wrong. 
IYS_trawl_specimen$scientific_name <- gsub("Oncorhynchus tschawytscha", "Oncorhynchus tshawytscha", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Phacellophora camtchatica", "Phacellophora camtschatica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Argropelecus sladeni", "Argyropelecus sladeni", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Onychoteuthis borealijaponicus", "Onychoteuthis borealijaponica", IYS_trawl_specimen$scientific_name)
IYS_trawl_specimen$scientific_name <- gsub("Unknown fish", "Pisces", IYS_trawl_specimen$scientific_name)

# Rematch the unique recorded species to the WoRMS registry to ensure all names have been changed appropriately. Check manually because sometimes multiple AphiaIDs are associated to a taxa or species, which need to be removed. 
IYS_spp_scientificnames <- worrms::wm_records_names(unique(IYS_trawl_specimen$scientific_name)) %>% bind_rows() %>% rename(scientific_name = scientificname) %>%
  select(scientific_name, AphiaID, lsid) %>% filter(!AphiaID %in% c("1434994", "106331", "163921"))

IYS_trawl_specimen <- left_join(IYS_trawl_specimen, IYS_scientificnames, by = "scientific_name") %>%
  rename(scientific_name_id = lsid) %>%
  select(-c(AphiaID, alternative_id))

#TODO figure length type for NW explorer

# Save specimen data:
write_csv(IYS_trawl_specimen, here("output_datasets", "IYS_trawl_specimen.csv"))
```

Next, integrate the CTD data (please note, we do not have CTD/Rosette data from the NW Explorer):

# CTD

```{r 2022 TINRO CTD}
TINRO_CTD <- read_excel(here("input_datasets", "IYS2022_TINRO_Data.xlsx"), sheet = "7. CTD INFO") |> 
    select(-c(sea_water_conductivity, sea_water_EC25, sea_water_turbidity,
         sea_water_chl_fluorescence, sea_water_chl_concentration,
         sea_water_dissolvedO2, sea_water_dissolvedO2_sat,
         sea_water_pH, sea_water_BOD5, Comments)) |> 
  rename(station_event_id = Station_Event_ID,
         instrument_type = Instrument_Type,
         instrument_model = Instrument_Model,
         sampling_depth_dbar = Sampling_Depth_Dbar,
         sea_water_temperature_degC = sea_water_temperature,
         sea_water_salinity_PSU = sea_water_salinity,
         `sea_water_density_kg/m3` = sea_water_density,
         ) |> 
  left_join(select(filter(TINRO_event, event_type == "CTD"), station_event_id, latitude_start_decdeg), by = "station_event_id") |> 
  mutate(sampling_depth_meters = swDepth(sampling_depth_dbar, latitude = latitude_start_decdeg)) |> 
  select(-latitude_start_decdeg)
```

```{r 2019 Kaganovsky CTD}
 
ctd_2019_data <- IYS_2019_CTD |> 
   select(station_event_ID, instrument_type:`sea_water_BOD5_mL/L`) %>%
  rename(station_event_id = station_event_ID)

```

```{r 2020 CTD}
ctd_2020 <- read_csv("https://raw.githubusercontent.com/international-year-of-the-salmon/2020-CTD/master/standardized_data/2020_ctd.csv") |> 
  select(-cast) %>%
  rename(station_event_id = station_event_ID)
```


```{r Overall CTD}

janitor::compare_df_cols(TINRO_CTD, ctd_2019_data, ctd_2020)

IYS_CTD <- bind_rows(TINRO_CTD, ctd_2019_data, ctd_2020) |> 
  select(station_event_id:sampling_depth_dbar, sampling_depth_meters,
         sea_water_temperature_degC:`sea_water_dissolvedO2_sat_%`,
         `sea_water_concentration_of_oxygen_mL/L`, sea_water_pH:`sea_water_oxygen_mL/L`)

# QC value ranges for unit issues
ranges <- IYS_CTD |> 
  left_join(select(IYS_events, station_event_id, vessel_name_abbr)) |> 
  group_by(vessel_name_abbr) |> 
  summarise_all(range, na.rm = TRUE)
ranges
#TODO Include more columns/variables once confident in comparability
IYS_CTD <- IYS_CTD |> 
  select(station_event_id, instrument_type, sampling_depth_meters,
         sea_water_temperature_degC, sea_water_salinity_PSU)

IYS_CTD <- right_join(select(IYS_events, station_event_id, event_date, latitude_start_decdeg, longitude_start_decdeg), IYS_CTD, by = "station_event_id")

#TODO: Ensure Sigma T is comparable across vessels
#TODO: Figure out why there isn't conductivity from TINRO vessel
#TODO: Figure out whether oxygen measurements can be unit converted and combined
#

write_csv(IYS_CTD, here("output_datasets", "IYS_CTD.csv"))

```

# Biogeochemistry Data

Include Biogeochemistry data

```{r}
#TODO combine rosette and CTD event IDs where possible
#TODO creat 'bottle file' from rosette and CTD data (probably just add ctd data to rosette table at appropriate depths)
#TODO add 2022 Nutrient and oxygen data

TINRO_bottles <- read_excel(here("input_datasets", "IYS2022_TINRO_Data.xlsx"), 
                          sheet = "8. ROSETTE INFO")


```


# QC

```{r QC relations}

dm_no_keys <- dm(IYS_trawl_catch, IYS_events, IYS_trawl_specimen, IYS_CTD)

# add primary keys
only_pk <- dm_no_keys %>% 
  dm_add_pk(IYS_trawl_catch, catch_id) %>% 
  dm_add_pk(IYS_events, station_event_id) %>% 
  dm_add_pk(IYS_trawl_specimen, specimen_id)
  
only_pk %>% dm_examine_constraints() # checks for duplicates in PK

#TODO: resolve duplicated specimen_ids for NW Trawl

# add foreign keys
dm <- only_pk %>% 
  dm_add_fk(IYS_CTD, station_event_id, IYS_events) %>% 
  dm_add_fk(IYS_trawl_specimen, catch_id, IYS_trawl_catch) %>% 
  dm_add_fk(IYS_trawl_catch, station_event_id, IYS_events)


issues <- dm %>% dm_examine_constraints() # checks that foreign keys all have a matching primary key in  the parent table
issues

#TODO: resolve values of `IYS_trawl_specimen$catch_id` not in `IYS_trawl_catch$catch_id`

# manually  export the drawing from the viewer pane to figs to update the data model image
dm_draw(dm)
```

Combine all data frames into a single .xlsx workbook:

```{r final_join}
# All IYS Expeditions:
out <- list("Sampling_Events" = IYS_events, "Trawl_Catch_Data" = IYS_trawl_catch, "Trawl_Specimen_Data" = IYS_trawl_specimen,
            "CTD_Data" = IYS_CTD)

writexl::write_xlsx(out, here("IYS_Integrated_Data_Collection_V3.xlsx"))
```

Create polygon coordinates for all events

```{r polygon coords}

polygon_coords <- function(df) {
  df <- df %>% tidyr::drop_na(lat, lon) %>% 
    dplyr::mutate(lon = dplyr::if_else(lon < 0, 360 + lon, lon))
  ch <- chull(df)
  coords <- df[c(ch, ch[1]), ]
  coords <- paste(coords$lat, coords$lon, sep = ",", collapse = " ")
  coords
}

df <- IYS2022_trawl_event %>% 
  select(lat = Latitude_Start_DecDeg, lon = Longitude_Start_DecDeg) %>% 
  filter(lat != 0 | lon != 0)

#copy output from console into metadata intake form polygon coordinates  
polygon_coords(df)

max(IYS2022_trawl_event$Maximum_Sampling_Depth_Meters)

```

```{r Stations list}
# This can be re-written later. I produced this stations plot list for Tetjana Ross
stations <- IYS2022_trawl_event |> 
  filter(event_type %in% c("CanTrawl", "Trawl")) |> 
  distinct(vessel_name_abbr, year, month, day, latitude_start_decdeg, longitude_start_decdeg) |> 
  rename(Lat = latitude_start_decdeg,
         Long = longitude_start_decdeg,
         vessel = vessel_name_abbr)

Franklin_stations <- Franklin_event |> 
  filter(Event_Type == "Trawl") |> 
  mutate(year = year(Time_Start_UTC),
         month = month(Time_Start_UTC),
         day = day(Time_Start_UTC)) |> 
  select(vessel = Vessel_Name_Abbr, year, month, day,
         Lat = Latitude_Start_DecDeg,
         Long = Longitude_Start_DecDeg)
  

stations_2019 <- GoA2019_event |> 
  mutate(year = year(EVENT_DATE),
         month = month(EVENT_DATE),
         day = day(EVENT_DATE)) |> 
  select(year, month, day, Lat = START_LATITUDE_DD, Long = longitude) |> 
  distinct()|> 
  mutate(vessel = "Kaganovksy")

stations_2020 <- GoA2020_event |> 
  mutate(year = year(EVENT_DATE),
         month = month(EVENT_DATE),
         day = day(EVENT_DATE)) |> 
  select(year, month, day, Lat = START_LAT_DECDEGREE, Long = START_LONG_DECDEGREE) |> 
  distinct() |> 
  mutate(vessel = "Pacific Legacy")


stations <- bind_rows(stations, Franklin_stations)

write_csv(stations, "stations.csv")
```

```{r join CTD data}

kag_ctd <- dplyr::right_join(IYS_events, IYS_CTD, by = c("station_event_id")) |> 
  filter(vessel_name_abbr == "Kaganovsky") |> 
  select(vessel_name_abbr, station, 
         sampling_depth_meters:sea_water_salinity_PSU)

kag_trawls <- IYS_events |> 
  filter (vessel_name_abbr == "Kaganovsky")

kag_ctd_trawls <- dplyr::right_join(kag_trawls, kag_ctd, by = "station")

anti_join(kag_trawls, kag_ctd, by = "station")

# Pacific Legacy 

leg_ctd <- dplyr::right_join(IYS_events, IYS_CTD, by = "station_event_id") |> 
  filter(vessel_name_abbr == "Legacy") |> 
  select(vessel_name_abbr, station, sampling_depth_meters:sea_water_salinity_PSU)

leg_trawls <- IYS_events |> 
  filter (vessel_name_abbr == "Legacy")

leg_ctd_trawls <- dplyr::right_join(leg_trawls, leg_ctd, by = "station")


anti_join(leg_trawls, leg_ctd, by = "station")
```
