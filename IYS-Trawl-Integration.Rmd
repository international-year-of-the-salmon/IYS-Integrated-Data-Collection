---
title: "IYS-Trawl-Integration"
author: "Tim van der Stap"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(lubridate)
library(obistools)
library(chron)
library(janitor)
knitr::opts_chunk$set(echo = TRUE)
```

For date integration, first download the processed data. For the 2022 data, this will be included in the IYS-data-template. From public repositories, we can download straight from the repository:  

```{r download}
download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-TINRO-Data-Template/blob/main/IYS2022_TINRO.xlsx?raw=true", here::here("IYS2022_TINRO_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/IYS2022_Shimada_Data_template.xlsx?raw=true", here::here("IYS2022_Shimada_Data.xlsx"), quiet = TRUE, mode = "wb")
```

From private repositories, use the following chunk of code, making sure to change the github_link to point to the correct private repository.

```{r private repo download, eval = FALSE}
# To download the GoA2019 Trawl data from the private repository, use the following steps:
# 1. Generate PAT token, making sure you get 'repo' access. 
# 2. Copy to URL to the raw file in GitHub. 
# 3. Add your PAT in the url, so that url reads "https://<PAT>@<url>"
# 4. In the terminal, download the file from the repository using: curl -s -O <url>

github_link <- "https://github.com/international-year-of-the-salmon/2019-FishTrawl/blob/master/original_data/JuvSalmon_2019-01_Specimens_v21.01b_SUBMITTED_COPY%20(2).xlsx"
library(httr)
temp_file <- tempfile(fileext = ".xlsx")
req <- GET(github_link, 
           # authenticate using GITHUB_PAT
           authenticate(Sys.getenv("GITHUB_PAT"), ""),
           # write result to disk
           write_disk(path = temp_file))
tab <- readxl::read_excel(temp_file)
tab

github_link <- "https://github.com/CerebralMastication/Presentations/raw/master/test.xlsx"
library(httr)
temp_file <- tempfile(fileext = ".xlsx")
req <- GET(github_link, 
          # authenticate using GITHUB_PAT
           authenticate(Sys.getenv("GITHUB_PAT"), ""),
          # write result to disk
           write_disk(path = temp_file))
tab2 <- openxlsx::loadWorkbook(temp_file)
tab <- readxl::read_excel(temp_file)
tab
```

Now that we have the latest versions of the trawl data downloaded, we can read them in:

```{r event data, eval = FALSE}
NW_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Sampling_Event_Info") %>%
  filter(Event_Type == "CanTrawl")
TINRO_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type == "Trawl")
Shimada_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_Shimada_Data.xlsx", sheet = "4. SAMPLING EVENT INFO") %>%
  filter(Event_Type %in% c("Trawl", "CTD"))
GoA2019_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/JuvSalmon_2019-01_catch.v20.12_FINAL_SUBMITTED (2).xlsx", 
                            sheet = "BRIDGE_LOG_FINAL")
```

Compare event tables from the various vessel sampling events:

```{r event comparison, eval = FALSE}
# Check for differences in column header names and class between those two data frames:
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event)
```

Looks like we have to do a little bit of cleaning before we join the data frames!

```{r Shimada cleaning, eval = FALSE}
Shimada_event <- Shimada_event %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")) %>%
  dplyr::rename(Bottom_Depth_Meters = `Bottom_Depth*_Meters`)
```

For NW data:

```{r NW cleaning, eval = FALSE}
NW_event <- NW_event %>%
  dplyr::rename(Maximum_Sampling_Depth_Meters = Maximum_Sampling_Depth,
                Minimum_Sampling_Depth_Meters = Minimum_Sampling_Depth,
                Cruise_name = Cruise_Name) # remember: rename(new = old)

# Change class where needed:
NW_event$Month <- as.numeric(NW_event$Month)
NW_event$Day <- as.numeric(NW_event$Day)
NW_event$Time_End <- as.POSIXct(NW_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")
NW_event$Time_Start <- as.POSIXct(NW_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

# NW Cruise_name and Station Event ID have to be slightly altered:
NW_event$Cruise_name <- str_replace(NW_event$Cruise_name, "NW2201", "IYS2022")
NW_event$Station_Event_ID <- str_replace(NW_event$Station_Event_ID, "NW2201", "IYS2022")
```

And for TINRO data:

```{r TINRO cleaning, eval = FALSE}
# Trawl data is collected in GMT+12:00. So we have to subtract 12 hours from the Time_Start and Time_End to get to UTC. Additionally, we have to make sure this is then accurately reflected in the sampling **day** as well!
hrs <- 12 * 60 * 60

TINRO_event$date <- as.Date(paste(TINRO_event$Year, TINRO_event$Month, TINRO_event$Day, sep = "-"))
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S")
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

TINRO_event <- TINRO_event %>%
  mutate(eventDate_start = paste(date, Time_Start)) %>%
  mutate(eventDate_start = as.POSIXlt(TINRO_event$eventDate_start))
TINRO_event$eventDate_start$hour = TINRO_event$eventDate_start$hour-12

TINRO_event$Year <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%Y"))
TINRO_event$Month <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%m"))
TINRO_event$Day <- as.numeric(format(as.Date(TINRO_event$eventDate_start), "%d"))

# Reformat time, and transform to UTC:
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S")
TINRO_event$Time_End <- TINRO_event$Time_End - hrs
TINRO_event$Time_End <- as.POSIXct(TINRO_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S") 

TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S")
TINRO_event$Time_Start <- TINRO_event$Time_Start - hrs
TINRO_event$Time_Start <- as.POSIXct(TINRO_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")# Change class and time to UTC for integration

# Sampling duration minutes has to be reformatted.
TINRO_event$Sampling_Duration_Minutes <- 60 * 24 * as.numeric(chron::times(TINRO_event$Sampling_Duration_Minutes)) 
TINRO_event$Sampling_Duration_Minutes <- round(TINRO_event$Sampling_Duration_Minutes, digits = 2)

# Change Time_Zone_Code to state that the Time_Start and Time_End now reflects UTC:
TINRO_event$Time_Zone_Code <- "GMT"

# Remove temporary columns:
TINRO_event <- TINRO_event %>% select(-c(date, eventDate_start))
```

Clean up the GoA2019 Trawl event data:

```{r GOA2019, eval = FALSE}
GoA2019_event$END_DEPLOYMENT_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$END_DEPLOYMENT_TIME), format = "%H%M"), 12, 16) 
GoA2019_event$BEGIN_RETRIEVAL_TIME <- substr(as.POSIXct(sprintf("%04.0f", GoA2019_event$BEGIN_RETRIEVAL_TIME), format = "%H%M"), 12, 16)

GoA2019_event <- GoA2019_event %>%
  mutate(Cruise_name = "IYS2022",
         Vessel_Name_Abbr = "Professor Kaganovskiy",
         Zone = " ",
         Time_Zone_Code = "GMT+12",
         Minimum_Sampling_Depth_Meters = 0) %>%
  dplyr::rename(Station = TOW_NUMBER,
                Event_Type = EVENT_TYPE,
                Time_Start = END_DEPLOYMENT_TIME,
                Time_End = BEGIN_RETRIEVAL_TIME,
                Sampling_Duration_Minutes = TOW_DURATION,
                Day_Night = `Day /Night`,
                Maximum_Sampling_Depth_Meters = MOUTH_OPENING_HEIGHT,
                Latitude_Start_DecDeg = START_LATITUDE_DD,
                Longitude_Start_DecDeg = longitude,
                Latitude_End_DecDeg = END_LATITUDE_DD,
                Longitude_End_DecDeg = END_LONGITUDE_DD,
                Bottom_Depth_Meters = BOTTOM_DEPTH_START_METERS,
                Tow_distance_nautical_miles = DISTANCE_TRAVELLED,
                Tow_speed_kilometers_per_hour = SPEED,
                Wind_Direction_Degrees = WIND_DIRECTION,
                Wind_Speed_kilometers_per_hour = WIND_SPEED,
                Weather_description = WEATHER_COMMENTS, 
                Comments = `COMMENTS TRANSLATED TO ENGLISH`)

GoA2019_event$Year <- as.numeric(format(as.Date(GoA2019_event$EVENT_DATE), "%Y"))
GoA2019_event$Month <- as.numeric(format(as.Date(GoA2019_event$EVENT_DATE), "%m"))
GoA2019_event$Day <- as.numeric(format(as.Date(GoA2019_event$EVENT_DATE), "%d"))

# Change some classes:
GoA2019_event$Zone <- as.numeric(GoA2019_event$Zone)
GoA2019_event$Wind_Direction_Degrees <- as.numeric(GoA2019_event$Wind_Direction_Degrees)
GoA2019_event$Wind_Speed_kilometers_per_hour <- as.numeric(GoA2019_event$Wind_Speed_kilometers_per_hour)

GoA2019_event <- GoA2019_event %>%
  mutate(Sampling_Duration_Minutes = Sampling_Duration_Minutes * 60,
         Station_EventID = paste(Cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Longitude_End_DecDeg = Longitude_End_DecDeg * -1) %>%
  select(Cruise_name, Vessel_Name_Abbr, Zone, Station, Event_Type, Year, Month, Day, Time_Start, Time_End, Sampling_Duration_Minutes, Day_Night,
         Time_Zone_Code, Minimum_Sampling_Depth_Meters, Maximum_Sampling_Depth_Meters, Tow_speed_kilometers_per_hour, Latitude_Start_DecDeg, 
         Longitude_Start_DecDeg, Latitude_End_DecDeg, Longitude_End_DecDeg, Bottom_Depth_Meters, Tow_distance_nautical_miles,
         Wind_Direction_Degrees, Wind_Speed_kilometers_per_hour, Comments)
```

Finally, join the data frames into a single sampling event data table: 

```{r IYS2022 sampling event, eval = FALSE}
# Check for differences in column header names and class between those two data frames:
janitor::compare_df_cols(NW_event, TINRO_event, Shimada_event)

# Join the individual event data frames:
IYS2022_trawl_event <- bind_rows(TINRO_event, NW_event, Shimada_event)

# Save event data:
write_csv(IYS2022_trawl_event, "IYS2022_trawl_event.csv")
```

Now let's join the overall catch data from these vessels into a specific data frame as well. 

```{r overall catch, eval = FALSE}
NW_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Catch_Info")
TINRO_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "5. CATCH_FINAL INFO")
Shimada_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_Shimada_Data.xlsx", sheet = "5. CATCH_FINAL INFO")
GoA2019_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/JuvSalmon_2019-01_catch.v20.12_FINAL_SUBMITTED (2).xlsx",
                            sheet = "CATCH_FINAL")
```

Cleaning NW catch column names:

```{r NW catch clean, eval = FALSE}
NW_catch <- NW_catch %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Species_recorded = Species_Recorded,
                Catch_weight = Catch_Weight,
                Catch_count = Catch_Count)

# Change NW2201 in Station Event ID and Catch ID:
NW_catch$Station_Event_ID <- str_replace(NW_catch$Station_Event_ID, "NW2201", "IYS2022")
NW_catch$Catch_ID <- str_replace(NW_catch$Catch_ID, "NW2201", "IYS2022")
```

Cleaning Shimada catch column names to ensure integration:

```{r Shimada catch clean, eval = FALSE}
Shimada_catch <- Shimada_catch %>%
  dplyr::rename(dateIdentified = `dateIdentified (UTC)`)
```

Cleaning GoA2019 catch column names:

```{r GOA2019 catch clean, eval = FALSE}
GoA2019_catch <- GoA2019_catch %>%
  mutate(cruise_name = "IYS2022",
         Vessel_Name_Abbr = "Professor Kaganovskiy",
         Zone = " ",
         Event_Type = "Trawl") %>%
  dplyr::rename(Station = `TOW_NUMBER (number)`,
                common_name = `common name`,
                Catch_weight = `Mass_codend (no expansion)`,
                Catch_count = `CATCH_COUNT (pieces)(**includes Russian expansion for some species)`,
                Lifestage = `age group ( for salmon 5= juv, 4 immature, 3 mature, 0 unknown)`,
                Comments = COMMENTS) %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_Name_Abbr, Station, Event_Type, sep = "-"),
         Catch_ID = paste(Station_Event_ID, row_number(), sep = "-"),
         Species_recorded = NA,
         Scientific_Name = paste(genus, species, sep = " "),
         Taxonomic_rank = ifelse(grepl("sp.", GoA2019_catch$species), "genus", "species"),
         Catch_weight_units = "kilograms") %>%
  select(Station_Event_ID, Catch_ID, Species_recorded, Scientific_Name, Taxonomic_rank, Lifestage, common_name, Catch_weight, Catch_weight_units,
         Catch_count, Comments)

```

Compare column names between catch data frames: 

```{r bridgelog, eval = FALSE}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_catch, TINRO_catch, Shimada_catch)

# Bind rows and save: 
IYS2022_trawl_catch <- bind_rows(TINRO_catch, NW_catch, Shimada_catch)
IYS2022_trawl_catch$dateIdentified <- as.character(IYS2022_trawl_catch$dateIdentified)

# Save catch data:
write_csv(IYS2022_trawl_catch, "IYS2022_trawl_catch.csv")
```

Now let's join the overall specimen data from these vessels into a specific data frame as well. 

```{r overall catch, eval = FALSE}
NW_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Specimen_Info")
TINRO_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "6. SPECIMEN INFO")
Shimada_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_Shimada_Data.xlsx", sheet = "6. SPECIMEN INFO")
GoA2019_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/JuvSalmon_2019-01_Specimens_v21.01b_SUBMITTED_COPY (2).xlsx",
                            sheet = "SPECIMEN_FINAL")
```

Cleaning Shimada specimen column names, only remove Barcode column:

```{r Shimada specimen clean, eval = FALSE}
Shimada_specimen <- Shimada_specimen %>%
  select(-`Barcode number`)
```

Selecting TINRO specimen column names for integration:

```{r TINRO specimen clean, eval = FALSE}
TINRO_specimen <- TINRO_specimen %>%
  select(Station_Event_ID, Catch_ID, Specimen_ID, Alternative_ID, Species_Recorded, Scientific_Name, Taxonomic_rank, common_name, Sex,
         Lifestage, Specimen_Length, Length_Units, Length_Type, Specimen_Weight, Weight_Units, Weight_Type, Comments)
```

Cleaning NW specimen column names:

```{r NW specimen clean, eval = FALSE}
NW_specimen <- NW_specimen %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Specimen_ID = `Specimen ID`,
                Specimen_Length = Length,
                Specimen_Weight = Weight)

# Change NW2201 in Station Event ID and Catch ID:
NW_specimen$Station_Event_ID <- str_replace(NW_specimen$Station_Event_ID, "NW2201", "IYS2022")
NW_specimen$Catch_ID <- str_replace(NW_specimen$Catch_ID, "NW2201", "IYS2022")
NW_specimen$Specimen_ID <- str_replace(NW_specimen$Specimen_ID, "NW2201", "IYS2022")
```

Clean the GOA2019 Trawl specimen data to integrate with 2022 data:

```{r GOA2019 specimen clean, eval = FALSE}
GoA2019_specimen <- GoA2019_specimen %>%
  mutate(cruise_name = "IYS2022",
         Vessel_name_abbr = "Professor Kaganovskiy", 
         Zone = " ",
         Event_Type = "Trawl",
         data_type = "specimen",
         Scientific_Name = paste(genus, species, sep = " ")) %>%
  dplyr::rename(Station = TOW_NUMBER,
                common_name = `common name`) %>%
  select(Station, common_name, LENGTH, SEX_CODE, `WEIGHT - TOTAL`, cruise_name, Vessel_name_abbr, Zone, Scientific_Name, Event_Type,
         data_type)

GoA2019_specimen <- GoA2019_specimen %>%
  mutate(Station_Event_ID = paste(cruise_name, Vessel_name_abbr, Station, Event_Type, sep = "-"))

# We want to compare the catch and the specimen data tables by joining them by Station_Event_ID and Scientific_Name. Therefore, we have to ensure that the spelling of Scientific_Names at least matches between these data frames (regardless of whether it is accuratedly represented in WORMS)
specimen_unique <- unique(GoA2019_specimen$Scientific_Name)
catch_unique <- unique(GoA2019_catch$Scientific_Name)

setdiff(specimen_unique, catch_unique)

# You can notice that in the specimen data, species names' are often followed by Russian (e.g. полов.). We need to remove these as otherwise we can't properly connect the catch to the specimen data. 
GoA2019_specimen$Scientific_Name <- gsub("[()]", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" неполов.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" сегол.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" полов.", "", GoA2019_specimen$Scientific_Name)
GoA2019_specimen$Scientific_Name <- gsub(" мол.", "", GoA2019_specimen$Scientific_Name)

# Make sure to remove the  мол. from the catch data as well. 
GoA2019_catch$Scientific_Name <- gsub("[()]", "", GoA2019_catch$Scientific_Name)
GoA2019_catch$Scientific_Name <- gsub(" мол.", "", GoA2019_catch$Scientific_Name)
GoA2019_catch$Scientific_Name <- gsub("Phacellophora camtshchatica", "Phacellophora camtschatica", GoA2019_catch$Scientific_Name)

# Left join to the GoA2019_catch data table so that we can create the specimen_IDs
merge <- left_join(GoA2019_catch, GoA2019_specimen, by = c("Station_Event_ID", "Scientific_Name"))
merge <- merge %>% group_by(Catch_ID) %>% 
  mutate(Specimen_ID = paste(Catch_ID, row_number(), sep = "-")) %>%
  ungroup()

GOA2019_specimen_tab <- merge %>% filter(data_type == "specimen") %>%
  dplyr::rename(Species_Recorded = Species_recorded,
                Specimen_Length = LENGTH,
                Specimen_Weight = `WEIGHT - TOTAL`,
                Sex = SEX_CODE) %>%
  select(Station_Event_ID, Catch_ID, Specimen_ID, Species_Recorded, Scientific_Name, Lifestage, Specimen_Length,
         Specimen_Weight, Sex)

```

Join the specimen data rows. 

```{r specimen, eval = FALSE}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_specimen, TINRO_specimen, Shimada_specimen)

# Bind rows and save: 
IYS2022_trawl_specimen <- bind_rows(TINRO_specimen, NW_specimen, Shimada_specimen)

# Save event data:
write_csv(IYS2022_trawl_specimen, "IYS2022_trawl_specimen.csv")
```

Next, integrate the CTD data (please note, we do not have CTD/Rosette data from the NW Explorer):

```{overall CTD, eval = FALSE}
TINRO_CTD <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "7. CTD INFO")
Shimada_CTD <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_Shimada_Data.xlsx", sheet = "7. CTD INFO")
```

Combine all data frames into a single .xlsx workbook:

```{r final_join, eval = FALSE}
out <- list("Sampling Info" = IYS2022_trawl_event, "Overall_Catch_Data" = IYS2022_trawl_catch, "Overall_Specimen_Data" = IYS2022_trawl_specimen)
writexl::write_xlsx(out, "master.xlsx")
```
