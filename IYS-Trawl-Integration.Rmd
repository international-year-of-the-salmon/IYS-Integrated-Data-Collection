---
title: "IYS-Trawl-Integration"
author: "Tim van der Stap"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(here)
library(lubridate)
library(obistools)
library(chron)
library(xlsx)
library(janitor)
knitr::opts_chunk$set(echo = TRUE)
```

For date integration, first download the processed data. For the 2022 data, this will be included in the IYS-data-template.  

```{r download}
download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-TINRO-Data-Template/blob/main/IYS2022_TINRO.xlsx?raw=true", here::here("IYS2022_TINRO_Data.xlsx"), quiet = TRUE, mode = "wb")

NW_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Sampling_Event_Info")
TINRO_event <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "4. SAMPLING EVENT INFO")
```

Compare event tables from the various vessel sampling events:

```{r event comparison, eval = FALSE}
# Check for differences in column header names and class between those two data frames:
janitor::compare_df_cols(NW_event, TINRO_event)
```

Looks like we have to do a little bit of cleaning before we join the data frames!

```{r NW cleaning, eval = FALSE}
NW_event <- NW_event %>%
  dplyr::rename(Maximum_Sampling_Depth_Meters = Maximum_Sampling_Depth,
                Minimum_Sampling_Depth_Meters = Minimum_Sampling_Depth,
                Cruise_name = Cruise_Name) # remember: rename(new = old)

# Change class where needed:
NW_event$Month <- as.numeric(NW_event$Month)
NW_event$Day <- as.numeric(NW_event$Day)
NW_event$Time_End <- as.POSIXct(NW_event$Time_End, format = "%H:%M:%S") %>% format("%H:%M:%S")
NW_event$Time_Start <- as.POSIXct(NW_event$Time_Start, format = "%H:%M:%S") %>% format("%H:%M:%S")

# NW Cruise_name and Station Event ID have to be slightly altered:
NW_event$Cruise_name <- str_replace(NW_event$Cruise_name, "NW2201", "IYS2022")
NW_event$Station_Event_ID <- str_replace(NW_event$Station_Event_ID, "NW2201", "IYS2022")
```

And for TINRO data:

```{r TINRO cleaning, eval = FALSE}
# Sampling duration minutes has to be reformatted.
TINRO_event$Sampling_Duration_Minutes <- format(TINRO_event$Sampling_Duration_Minutes, format = "%H:%M:%S") 
TINRO_event$Sampling_Duration_Minutes <- 60 * 24 * as.numeric(chron::times(TINRO_event$Sampling_Duration_Minutes)) 
TINRO_event$Sampling_Duration_Minutes <- round(TINRO_event$Sampling_Duration_Minutes, digits = 2)

TINRO_event$Time_End <- format(TINRO_event$Time_End, format = "%H:%M:%S")
TINRO_event$Time_Start <- format(TINRO_event$Time_Start, format = "%H:%M:%S")
```

Finally, join the data frames into a single sampling event data table: 

```{r IYS2022 sampling event, eval = FALSE}
# Join the individual event data frames:
bridgelog_trawl_all <- bind_rows(TINRO_event, NW_event)

# Save event data:
write_csv(bridgelog_trawl_all, "overall_bridgelog.csv")
```

Now let's join the overall catch data from these vessels into a specific data frame as well. 

```{r overall catch, eval = FALSE}
NW_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Catch_Info")
TINRO_catch <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "5. CATCH_FINAL INFO")
```

Cleaning NW catch column names:

```{r NW catch clean, eval = FALSE}
NW_catch <- NW_catch %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Species_recorded = Species_Recorded,
                Catch_weight = Catch_Weight,
                Catch_count = Catch_Count)

# Change NW2201 in Station Event ID and Catch ID:
NW_catch$Station_Event_ID <- str_replace(NW_catch$Station_Event_ID, "NW2201", "IYS2022")
NW_catch$Catch_ID <- str_replace(NW_catch$Catch_ID, "NW2201", "IYS2022")
```

Compare column names between catch data frames: 

```{r bridgelog, eval = FALSE}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_catch, TINRO_catch)

# Bind rows and save: 
catch <- bind_rows(TINRO_catch, NW_catch)

# Save catch data:
write_csv(catch, "overall_catch.csv")
```

Now let's join the overall specimen data from these vessels into a specific data frame as well. 

```{r overall catch, eval = FALSE}
NW_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_NW_Data.xlsx", sheet = "Specimen_Info")
TINRO_specimen <- read_excel("C:/Users/Admin/Desktop/GitHub/IYS-Trawl/IYS2022_TINRO_Data.xlsx", sheet = "6. SPECIMEN INFO")
```

Cleaning NW specimeh column names:

```{r NW catch clean, eval = FALSE}
NW_specimen<- NW_specimen %>%
  dplyr::rename(Station_Event_ID = `Station Event ID`,
                Catch_ID = `Catch ID`,
                Specimen_ID = `Specimen ID`,
                Specimen_Length = Length,
                Specimen_Weight = Weight)

# Change NW2201 in Station Event ID and Catch ID:
NW_specimen$Station_Event_ID <- str_replace(NW_specimen$Station_Event_ID, "NW2201", "IYS2022")
NW_specimen$Catch_ID <- str_replace(NW_specimen$Catch_ID, "NW2201", "IYS2022")
NW_specimen$Specimen_ID <- str_replace(NW_specimen$Specimen_ID, "NW2201", "IYS2022")
```

Join the specimen data rows. 

```{r specimen, eval = FALSE}
# Check for differences in column header names between those two data frames:
janitor::compare_df_cols(NW_specimen, TINRO_specimen)

# Bind rows and save: 
specimen <- bind_rows(TINRO_specimen, NW_specimen)

# Save event data:
write_csv(specimen, "overall_specimen.csv")
```

Combine all data frames into a single .xlsx workbook:

```{r final_join, eval = FALSE}
out <- list("Sampling Info" = bridgelog_trawl_all, "Overall_Catch_Data" = catch, "Overall_Specimen_Data" = specimen)
writexl::write_xlsx(out, "master.xlsx")
```
